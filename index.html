<!--
Cambios realizados:
- El botón "Ingresar como profesional" ahora abre un modal que solo muestra dos botones: "Ingresar" y "Registrarse".
- El modal profesional ahora contiene dos formularios: uno para login y otro para registro.
- El registro pide: Nombre completo, correo y contraseña.
- El login pide: Correo y contraseña.
- Después de registrarse, se inicia sesión automáticamente y se accede al panel profesional.
- El campo de profesión se elimina del registro y se solicita solo en el primer login si no está guardada.
-->

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PROGRAMA SENDA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* --- estilos igual que antes, omitidos por brevedad --- */
    /* (Pega aquí todos los estilos originales sin cambios, o mantenlos en el mismo archivo) */
    /* ... */
    /* Solo agregué esto para ocultar los forms alternadamente */
    .hidden { display: none !important; }
  </style>
  <!-- Firebase App (core) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <button class="boton-profesional" id="abrir-modal-profesional">
    Ingresar como profesional
  </button>
  <div class="container" id="main-panel">
    <h1>Programa SENDA</h1>
    <p>
      SENDA busca mitigar el impacto social y sanitario de los consumos de alcohol y otras drogas en niños, niñas, adolescentes, hombres, mujeres y colectivos de las diversidades sexo/genéricas, para mejorar el bienestar y la calidad de vida en las personas y comunidades.
    </p>
    <p>
      Para lograrlo, diseña, implementa, entrega de información, orienta, articula y coordina de acciones efectivas, oportunas y de calidad, considerando las particularidades del territorio.
    </p>
    <button class="boton-inscribirme" id="abrir-modal">
      Inscribirme
    </button>
  </div>
  
  <!-- Modal Solicitud paciente ... (igual que antes) -->

  <!-- Modal de Éxito paciente ... (igual que antes) -->

  <!-- Modal Profesional: SOLO login y registro -->
  <div class="modal-bg" id="modal-bg-login-profesional">
    <div class="modal">
      <button class="close-modal" id="cerrar-modal-login-profesional" title="Cerrar">&times;</button>
      <h2>Acceso profesional</h2>
      <div id="profesional-btns">
        <button type="button" class="boton-login" id="btn-mostrar-login">Ingresar</button>
        <button type="button" class="boton-login" id="btn-mostrar-registro">Registrarse</button>
      </div>
      <!-- LOGIN -->
      <form id="form-login-profesional" class="hidden">
        <div class="form-group">
          <label for="correo-profesional">Correo:</label>
          <input type="email" id="correo-profesional" name="correo-profesional" required>
        </div>
        <div class="form-group">
          <label for="clave-profesional">Contraseña:</label>
          <input type="password" id="clave-profesional" name="clave-profesional" required>
        </div>
        <div class="form-group" id="grupo-profesion-profesional" style="display:none;">
          <label for="profesion-profesional">Profesión:</label>
          <select id="profesion-profesional" name="profesion-profesional" required>
            <option value="">Seleccione...</option>
            <option value="asistente_social">Asistente social</option>
            <option value="medico">Médico</option>
          </select>
        </div>
        <div id="error-login-profesional" class="error-msg"></div>
        <button type="submit" class="boton-login">Ingresar</button>
      </form>
      <!-- REGISTRO -->
      <form id="form-registro-profesional" class="hidden">
        <div class="form-group">
          <label for="nombre-profesional">Nombre completo:</label>
          <input type="text" id="nombre-profesional" name="nombre-profesional" required>
        </div>
        <div class="form-group">
          <label for="correo-profesional-reg">Correo:</label>
          <input type="email" id="correo-profesional-reg" name="correo-profesional-reg" required>
        </div>
        <div class="form-group">
          <label for="clave-profesional-reg">Contraseña:</label>
          <input type="password" id="clave-profesional-reg" name="clave-profesional-reg" required>
        </div>
        <div id="error-registro-profesional" class="error-msg"></div>
        <button type="submit" class="boton-login">Registrarme</button>
      </form>
    </div>
  </div>

  <!-- Modal Panel Profesional ... (igual que antes) -->
  <!-- Modal Ficha Usuario ... (igual que antes) -->

  <script>
    // Inicializa Firebase (igual que antes)
    const firebaseConfig = {
      apiKey: "AIzaSyDEjlDOYhHrnavXOKWjdHO0HXILWQhUXv8",
      authDomain: "senda-6d5c9.firebaseapp.com",
      projectId: "senda-6d5c9",
      storageBucket: "senda-6d5c9.appspot.com",
      messagingSenderId: "1090028669785",
      appId: "1:1090028669785:web:d4e1c1b9945fc2fddc1a48",
      measurementId: "G-82DCLW5R2W"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const dominioPermitido = '@senda.cl';

    let profesionActual = "";
    let usuarioUid = "";

    // ---- MODAL profesional: solo login o registro ----
    document.getElementById('abrir-modal-profesional').onclick = function() {
      document.getElementById('modal-bg-login-profesional').style.display = 'flex';
      document.getElementById('error-login-profesional').style.display = 'none';
      document.getElementById('error-registro-profesional').style.display = 'none';
      document.getElementById('form-login-profesional').classList.add("hidden");
      document.getElementById('form-registro-profesional').classList.add("hidden");
      document.getElementById('profesional-btns').classList.remove("hidden");
      document.getElementById('form-login-profesional').reset();
      document.getElementById('form-registro-profesional').reset();
    };
    document.getElementById('cerrar-modal-login-profesional').onclick = function() {
      document.getElementById('modal-bg-login-profesional').style.display = 'none';
    };
    document.getElementById('modal-bg-login-profesional').onclick = function(e) {
      if(e.target === this) this.style.display = 'none';
    };
    // Mostrar login
    document.getElementById('btn-mostrar-login').onclick = function() {
      document.getElementById('profesional-btns').classList.add("hidden");
      document.getElementById('form-registro-profesional').classList.add("hidden");
      document.getElementById('form-login-profesional').classList.remove("hidden");
      document.getElementById('grupo-profesion-profesional').style.display = 'none';
      document.getElementById('error-login-profesional').style.display = 'none';
    };
    // Mostrar registro
    document.getElementById('btn-mostrar-registro').onclick = function() {
      document.getElementById('profesional-btns').classList.add("hidden");
      document.getElementById('form-login-profesional').classList.add("hidden");
      document.getElementById('form-registro-profesional').classList.remove("hidden");
      document.getElementById('error-registro-profesional').style.display = 'none';
    };

    // --- LOGIN PROFESIONAL ---
    document.getElementById('form-login-profesional').onsubmit = async function(e) {
      e.preventDefault();
      const correo = document.getElementById('correo-profesional').value.trim();
      const clave = document.getElementById('clave-profesional').value;
      const profesion = document.getElementById('profesion-profesional').value;
      const errorDiv = document.getElementById('error-login-profesional');

      if (!correo.endsWith(dominioPermitido)) {
        errorDiv.style.display = 'block';
        errorDiv.innerText = 'Solo se permite acceso con correo institucional (' + dominioPermitido + ')';
        return;
      }
      auth.signInWithEmailAndPassword(correo, clave)
        .then(async (userCredential) => {
          usuarioUid = userCredential.user.uid;
          // Consultar si ya tiene profesión guardada
          const docProf = await db.collection("usuarios").doc(usuarioUid).get();
          if(docProf.exists && docProf.data().profesion) {
            profesionActual = docProf.data().profesion;
            document.getElementById('grupo-profesion-profesional').style.display = 'none';
            abrirPanelProfesional();
          } else {
            // Si no existe, pedir profesión solo una vez
            if (!profesion) {
              document.getElementById('grupo-profesion-profesional').style.display = 'block';
              errorDiv.style.display = 'block';
              errorDiv.innerText = 'Seleccione su profesión y vuelva a ingresar.';
              return;
            }
            profesionActual = profesion;
            await db.collection("usuarios").doc(usuarioUid).set({ profesion: profesionActual });
            abrirPanelProfesional();
          }
        })
        .catch((error) => {
          errorDiv.style.display = 'block';
          errorDiv.innerText = 'Error: ' + error.message;
        });
    };

    // --- REGISTRO PROFESIONAL ---
    document.getElementById('form-registro-profesional').onsubmit = async function(e) {
      e.preventDefault();
      const nombre = document.getElementById('nombre-profesional').value.trim();
      const correo = document.getElementById('correo-profesional-reg').value.trim();
      const clave = document.getElementById('clave-profesional-reg').value;
      const errorDiv = document.getElementById('error-registro-profesional');
      if (!correo.endsWith(dominioPermitido)) {
        errorDiv.style.display = 'block';
        errorDiv.innerText = 'Solo se permite registro con correo institucional (' + dominioPermitido + ')';
        return;
      }
      if (!nombre) {
        errorDiv.style.display = 'block';
        errorDiv.innerText = 'Ingrese su nombre completo.';
        return;
      }
      auth.createUserWithEmailAndPassword(correo, clave)
        .then(async (userCredential) => {
          usuarioUid = userCredential.user.uid;
          await db.collection("usuarios").doc(usuarioUid).set({ nombre: nombre });
          // Al registrarse, lo enviamos directo al login
          // (o lo logueamos automáticamente y pedimos profesión)
          await auth.signInWithEmailAndPassword(correo, clave);
          document.getElementById('form-registro-profesional').classList.add("hidden");
          document.getElementById('form-login-profesional').classList.remove("hidden");
          document.getElementById('grupo-profesion-profesional').style.display = 'block';
          document.getElementById('correo-profesional').value = correo;
          document.getElementById('clave-profesional').value = clave;
          document.getElementById('error-login-profesional').innerText = 'Seleccione su profesión para completar el registro.';
          document.getElementById('error-login-profesional').style.display = 'block';
        })
        .catch((error) => {
          errorDiv.style.display = 'block';
          errorDiv.innerText = 'Error: ' + error.message;
        });
    };

    // Abrir panel profesional
    function abrirPanelProfesional() {
      document.getElementById('modal-bg-login-profesional').style.display = 'none';
      document.getElementById('panel-profesional-titulo').innerText =
        profesionActual === "asistente_social" ? "Asistente Social" : "Médico";
      document.getElementById('modal-bg-profesional-panel').style.display = 'flex';
      cargarSolicitudesProfesional();
    }

    // Logout profesional
    document.getElementById('logout-profesional').onclick = function() {
      auth.signOut().then(() => {
        document.getElementById('modal-bg-profesional-panel').style.display = 'none';
        profesionActual = "";
        usuarioUid = "";
      });
    };
    document.getElementById('cerrar-modal-profesional-panel').onclick = function() {
      document.getElementById('modal-bg-profesional-panel').style.display = 'none';
    };
    document.getElementById('modal-bg-profesional-panel').onclick = function(e) {
      if(e.target === this) this.style.display = 'none';
    };

    // --- Resto del código igual que antes (inscripción paciente, panel profesional, ficha, derivar, etc.) ---
    // (No requiere cambios para la funcionalidad pedida)
    // ...
    // (Puedes copiar y pegar todo el JS original aquí)

  </script>
</body>
</html>
