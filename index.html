<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PROGRAMA SENDA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #222;
    }
    .container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(44, 62, 80, 0.15);
      padding: 36px 32px;
      max-width: 600px;
      margin: 60px auto 30px auto;
      text-align: center;
    }
    h1, h2, h3 {
      color: #2e8b57;
      margin-bottom: 18px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .senda-link {
      color: #3b5998;
      text-decoration: underline;
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 18px;
      display: inline-block;
    }
    p {
      color: #444;
      font-size: 1.07rem;
      margin-bottom: 15px;
      line-height: 1.6;
    }
    button, .btn {
      background: linear-gradient(90deg, #2e8b57 40%, #3b5998 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      padding: 11px 28px;
      margin-top: 14px;
      box-shadow: 0 4px 16px rgba(44,62,80,0.1);
      transition: background 0.3s, transform 0.2s;
      display: inline-block;
    }
    button.small, .btn-small {
      padding: 7px 16px;
      font-size: 0.97rem;
      margin-top: 8px;
      margin-bottom: 5px;
    }
    button:hover, .btn:hover {
      background: linear-gradient(90deg, #226644 60%, #2e8b57 100%);
      transform: scale(1.05);
    }
    .tabs {
      display: flex;
      margin-bottom: 24px;
      justify-content: center;
      border-bottom: 1px solid #eee;
      gap: 0;
    }
    .tab {
      flex: 1;
      padding: 11px 0 8px 0;
      background: none;
      color: #2e8b57;
      border: none;
      border-bottom: 2px solid transparent;
      font-size: 1.08rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    .tab.active {
      border-bottom: 2.5px solid #3b5998;
      color: #222;
      background: #f5f5f5;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .solicitudes-list {
      margin-top: 8px;
      max-height: 420px;
      overflow-y: auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .solicitud-item {
      background: #f6f6f6;
      margin-bottom: 10px;
      padding: 16px;
      border-radius: 8px;
      font-size: 1.08rem;
      box-shadow: 0 1px 4px rgba(44,62,80,0.08);
      position: relative;
    }
    .solicitud-item strong {
      color: #2e8b57;
    }
    .derivar-select, .derivar-input {
      margin-top: 8px;
      margin-bottom: 6px;
      width: 100%;
      padding: 7px;
      border-radius: 6px;
      border: 1px solid #bdbdbd;
      font-size: 1rem;
      background: #fff;
      color: #444;
    }
    .derivacion-label {
      font-size: 1.07rem;
      color: #666;
      margin-top: 5px;
      margin-bottom: 2px;
      display: block;
    }
    .error-msg {
      color: #e53935;
      font-size: 0.98rem;
      text-align: center;
      margin-top: 10px;
      margin-bottom: 2px;
      display: none;
    }
    .ficha-buscar {
      margin-bottom: 14px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .ficha-buscar input {
      border-radius: 7px;
      border: 1px solid #ccc;
      padding: 7px;
      font-size: 1.05rem;
    }
    .ficha-label {
      font-weight: bold;
      color: #2e8b57;
      margin-top: 8px;
    }
    .ficha-notas {
      background: #f7f7f7;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      padding: 12px;
      margin-bottom: 8px;
      font-size: 0.97rem;
    }
    .ficha-nota-item {
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 6px;
      padding-bottom: 6px;
    }
    .ficha-nota-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .atencion-profesional {
      font-size: 0.97rem;
      margin-bottom: 6px;
      background: #eaf7ee;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #d4e7db;
    }
    .close-modal {
      position: absolute;
      right: 8px;
      top: 8px;
      background: none;
      border: none;
      font-size: 1.05rem;
      color: #888;
      cursor: pointer;
      transition: color 0.2s;
      font-weight: bold;
      padding: 0;
      line-height: 1;
      width: 22px;
      height: 22px;
      text-align: center;
    }
    .close-modal:hover {
      color: #2e8b57;
      font-size: 1.1rem;
    }
    .modal-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(34, 34, 34, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      display: none;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(44,62,80,0.18);
      padding: 30px 24px 24px 24px;
      max-width: 600px;
      width: 98vw;
      text-align: left;
      position: relative;
      animation: fadeIn 0.4s;
    }
    @keyframes fadeIn {
      from { transform: scale(0.85); opacity: 0;}
      to { transform: scale(1); opacity: 1;}
    }
    @media (max-width: 700px) {
      .container, .modal { max-width: 99vw; padding: 12px 2px; }
      .solicitud-item { padding: 8px; font-size: 0.97rem; }
      .tabs { font-size: 0.97rem; }
    }
  </style>
  <!-- Firebase App (core) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container" id="main-panel">
    <h1>Programa SENDA</h1>
    <a class="senda-link" href="https://www.senda.gob.cl/" target="_blank">Visita la página oficial de SENDA</a>
    <p>
      SENDA busca mitigar el impacto social y sanitario de los consumos de alcohol y otras drogas en niños, niñas, adolescentes, hombres, mujeres y colectivos de las diversidades sexo/genéricas, para mejorar el bienestar y la calidad de vida en las personas y comunidades.
    </p>
    <div>
      <button class="btn" id="abrir-modal-ingresar">Ingresar</button>
      <button class="btn" id="abrir-modal-registrar">Registrar</button>
    </div>
  </div>

  <!-- MODAL INGRESO -->
  <div class="modal-bg" id="modal-bg-ingresar">
    <div class="modal">
      <button class="close-modal" id="cerrar-modal-ingresar" title="Cerrar">&times;</button>
      <h2>Ingreso profesional</h2>
      <form id="form-ingresar">
        <div class="form-group">
          <label for="correo-ingresar">Correo institucional:</label>
          <input type="email" id="correo-ingresar" required>
        </div>
        <div class="form-group">
          <label for="clave-ingresar">Contraseña:</label>
          <input type="password" id="clave-ingresar" required>
        </div>
        <div id="error-ingresar" class="error-msg"></div>
        <button type="submit" class="btn">Ingresar</button>
      </form>
    </div>
  </div>

  <!-- MODAL REGISTRO -->
  <div class="modal-bg" id="modal-bg-registrar">
    <div class="modal">
      <button class="close-modal" id="cerrar-modal-registrar" title="Cerrar">&times;</button>
      <h2>Registro profesional</h2>
      <form id="form-registrar">
        <div class="form-group">
          <label for="nombre-registrar">Nombre completo:</label>
          <input type="text" id="nombre-registrar" required>
        </div>
        <div class="form-group">
          <label for="correo-registrar">Correo institucional:</label>
          <input type="email" id="correo-registrar" required>
        </div>
        <div class="form-group">
          <label for="clave-registrar">Contraseña:</label>
          <input type="password" id="clave-registrar" required>
        </div>
        <div class="form-group">
          <label for="profesion-registrar">Profesión:</label>
          <select id="profesion-registrar" required>
            <option value="">Seleccione...</option>
            <option value="asistente_social">Asistente social</option>
            <option value="medico">Médico</option>
          </select>
        </div>
        <div id="error-registrar" class="error-msg"></div>
        <button type="submit" class="btn">Registrar</button>
      </form>
    </div>
  </div>

  <!-- PANEL PROFESIONAL -->
  <div class="container" id="panel-profesional" style="display:none;">
    <h2>Panel profesional</h2>
    <div class="tabs">
      <button class="tab active" data-tab="mis-datos">Mis datos</button>
      <button class="tab" data-tab="solicitudes">Solicitudes</button>
      <button class="tab" data-tab="fichas">Fichas</button>
      <button class="btn btn-small" id="logout-btn" style="margin-left: auto;">Cerrar sesión</button>
    </div>
    <div class="tab-content active" id="tab-mis-datos"></div>
    <div class="tab-content" id="tab-solicitudes"></div>
    <div class="tab-content" id="tab-fichas"></div>
  </div>

  <!-- MODAL FICHA USUARIO -->
  <div class="modal-bg" id="modal-bg-ficha">
    <div class="modal" style="max-width:600px;">
      <button class="close-modal" id="cerrar-modal-ficha" title="Cerrar">&times;</button>
      <h2>Ficha de usuario</h2>
      <div id="ficha-usuario-info"></div>
      <div id="ficha-usuario-notas"></div>
      <form id="form-nota-ficha">
        <div class="form-group">
          <label for="nota-ficha">Registrar atención:</label>
          <textarea id="nota-ficha" name="nota-ficha" rows="2" required></textarea>
        </div>
        <button type="submit" class="btn btn-small">Guardar atención</button>
      </form>
    </div>
  </div>

  <!-- MODAL DERIVACION -->
  <div class="modal-bg" id="modal-bg-derivar">
    <div class="modal" style="max-width:500px;">
      <button class="close-modal" id="cerrar-modal-derivar" title="Cerrar">&times;</button>
      <h2>Derivar a médico</h2>
      <form id="form-derivar">
        <div class="form-group">
          <label for="observacion-derivar">Motivo de derivación:</label>
          <textarea id="observacion-derivar" rows="2" required></textarea>
        </div>
        <button type="submit" class="btn btn-small">Derivar</button>
      </form>
    </div>
  </div>

  <script>
    // Firebase inicialización
    const firebaseConfig = {
      apiKey: "AIzaSyDEjlDOYhHrnavXOKWjdHO0HXILWQhUXv8",
      authDomain: "senda-6d5c9.firebaseapp.com",
      projectId: "senda-6d5c9",
      storageBucket: "senda-6d5c9.appspot.com",
      messagingSenderId: "1090028669785",
      appId: "1:1090028669785:web:d4e1c1b9945fc2fddc1a48",
      measurementId: "G-82DCLW5R2W"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const dominioPermitido = '@senda.cl';
    let usuario = null; // {uid, nombre, correo, profesion}
    let solicitudesDerivarId = null;

    // MODALES
    function showModal(id) { document.getElementById(id).style.display = 'flex'; }
    function hideModal(id) { document.getElementById(id).style.display = 'none'; }
    document.getElementById('abrir-modal-ingresar').onclick = () => showModal('modal-bg-ingresar');
    document.getElementById('abrir-modal-registrar').onclick = () => showModal('modal-bg-registrar');
    document.getElementById('cerrar-modal-ingresar').onclick = () => hideModal('modal-bg-ingresar');
    document.getElementById('cerrar-modal-registrar').onclick = () => hideModal('modal-bg-registrar');
    document.getElementById('cerrar-modal-ficha').onclick = () => hideModal('modal-bg-ficha');
    document.getElementById('cerrar-modal-derivar').onclick = () => hideModal('modal-bg-derivar');
    document.getElementById('modal-bg-ingresar').onclick = e => {if(e.target===e.currentTarget)hideModal('modal-bg-ingresar');};
    document.getElementById('modal-bg-registrar').onclick = e => {if(e.target===e.currentTarget)hideModal('modal-bg-registrar');};
    document.getElementById('modal-bg-ficha').onclick = e => {if(e.target===e.currentTarget)hideModal('modal-bg-ficha');};
    document.getElementById('modal-bg-derivar').onclick = e => {if(e.target===e.currentTarget)hideModal('modal-bg-derivar');};

    // Registro profesional
    document.getElementById('form-registrar').onsubmit = async function(e){
      e.preventDefault();
      let nombre = document.getElementById('nombre-registrar').value.trim();
      let correo = document.getElementById('correo-registrar').value.trim();
      let clave = document.getElementById('clave-registrar').value;
      let profesion = document.getElementById('profesion-registrar').value;
      let errorDiv = document.getElementById('error-registrar');
      errorDiv.style.display = 'none';

      if(!correo.endsWith(dominioPermitido)){
        errorDiv.innerText = 'Solo se permite correo institucional ('+dominioPermitido+')';
        errorDiv.style.display = 'block'; return;
      }
      if(!nombre || !profesion){
        errorDiv.innerText = 'Debes ingresar tu nombre y profesión.';
        errorDiv.style.display = 'block'; return;
      }
      try{
        let res = await auth.createUserWithEmailAndPassword(correo,clave);
        let uid = res.user.uid;
        await db.collection("usuarios").doc(uid).set({nombre,correo,profesion});
        alert("Registro exitoso. Ahora ingresa.");
        hideModal('modal-bg-registrar');
        document.getElementById('form-registrar').reset();
      }catch(err){
        errorDiv.innerText = err.message;
        errorDiv.style.display = 'block';
      }
    };

    // Ingreso profesional
    document.getElementById('form-ingresar').onsubmit = async function(e){
      e.preventDefault();
      let correo = document.getElementById('correo-ingresar').value.trim();
      let clave = document.getElementById('clave-ingresar').value;
      let errorDiv = document.getElementById('error-ingresar');
      errorDiv.style.display = 'none';

      if(!correo.endsWith(dominioPermitido)){
        errorDiv.innerText = 'Solo se permite correo institucional ('+dominioPermitido+')';
        errorDiv.style.display = 'block'; return;
      }
      try{
        let res = await auth.signInWithEmailAndPassword(correo,clave);
        let uid = res.user.uid;
        let doc = await db.collection("usuarios").doc(uid).get();
        if(!doc.exists){
          errorDiv.innerText = 'Usuario sin datos registrados.';
          errorDiv.style.display = 'block'; return;
        }
        usuario = {uid, ...doc.data()};
        hideModal('modal-bg-ingresar');
        document.getElementById('form-ingresar').reset();
        mostrarPanelProfesional();
      }catch(err){
        errorDiv.innerText = err.message;
        errorDiv.style.display = 'block';
      }
    };

    // Logout
    document.getElementById('logout-btn').onclick = async function(){
      await auth.signOut();
      usuario = null;
      document.getElementById('panel-profesional').style.display = 'none';
      document.getElementById('main-panel').style.display = 'block';
    };

    // PANEL CON TABS
    function mostrarPanelProfesional(){
      document.getElementById('main-panel').style.display = 'none';
      document.getElementById('panel-profesional').style.display = 'block';
      activarTab('mis-datos');
      cargarMisDatos();
      cargarSolicitudes();
      cargarBuscadorFichas();
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.onclick = function(){
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        activarTab(tab.dataset.tab);
      };
    });
    function activarTab(tab){
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.getElementById('tab-'+tab).classList.add('active');
    }

    // Tab Mis Datos
    function cargarMisDatos(){
      document.getElementById('tab-mis-datos').innerHTML = `
        <div style="text-align:left;max-width:350px;margin:auto;padding:15px;">
          <div><b>Nombre completo:</b> ${usuario.nombre}</div>
          <div><b>Profesión:</b> ${usuario.profesion==='asistente_social'?'Asistente social':'Médico'}</div>
          <div><b>Correo:</b> ${usuario.correo}</div>
        </div>
      `;
    }

    // Tab Solicitudes
    async function cargarSolicitudes(){
      let lista = document.getElementById('tab-solicitudes');
      lista.innerHTML = '<div class="solicitudes-list"><p>Cargando solicitudes...</p></div>';
      let query;
      if(usuario.profesion==='asistente_social'){
        query = db.collection("solicitudes").orderBy("fecha", "desc");
      }else{
        query = db.collection("solicitudes").where("derivacion","==","medico").orderBy("fecha", "desc");
      }
      let snap = await query.get();
      let html = '<div class="solicitudes-list">';
      if(snap.empty){
        html += '<p>No hay solicitudes.</p>';
      }else{
        snap.forEach(doc=>{
          let s = doc.data(); let id = doc.id;
          html += `<div class="solicitud-item">
              <strong>Nombre:</strong> ${s.nombre} ${s.apellido}<br>
              <strong>RUT:</strong> ${s.rut}<br>
              <strong>Teléfono:</strong> ${s.telefono}<br>
              <strong>Correo:</strong> ${s.correo}<br>
              <strong>Comuna:</strong> ${s.comuna}<br>
              <strong>Dirección:</strong> ${s.direccion}<br>
              <strong>Fecha:</strong> ${s.fecha}<br>
              <strong>Derivación:</strong> ${s.derivacion==='medico'?'<span style="color:#3b5998;">Médico</span>':'Pendiente'}
              ${usuario.profesion==='asistente_social'&&s.derivacion!=='medico'?`
                <button class="btn btn-small" onclick="abrirDerivar('${id}')">Derivar a médico</button>
              `:""}
              ${usuario.profesion==='medico'&&s.derivacion==='medico'?`
                <button class="btn btn-small" onclick="verFichaUsuario('${id}')">Ver ficha</button>
              `:usuario.profesion==='asistente_social'?`
                <button class="btn btn-small" onclick="verFichaUsuario('${id}')">Ver ficha</button>
              `:""}
            </div>`;
        });
      }
      html += "</div>";
      lista.innerHTML = html;
    }
    window.abrirDerivar = function(id){
      solicitudesDerivarId = id;
      document.getElementById('observacion-derivar').value="";
      showModal('modal-bg-derivar');
    };
    document.getElementById('form-derivar').onsubmit = async function(e){
      e.preventDefault();
      let observacion = document.getElementById('observacion-derivar').value.trim();
      if(!observacion){alert("Debes escribir la observación.");return;}
      await db.collection("solicitudes").doc(solicitudesDerivarId).update({
        derivacion: "medico",
        observacion_derivacion: observacion,
        nombre_deriva: usuario.nombre,
        fecha_derivacion: new Date().toLocaleString()
      });
      hideModal('modal-bg-derivar');
      cargarSolicitudes();
    };

    // Tab Fichas
    function cargarBuscadorFichas(){
      document.getElementById('tab-fichas').innerHTML = `
        <div class="ficha-buscar">
          <input type="text" id="buscador-rut" placeholder="Buscar por RUT">
          <button class="btn btn-small" id="buscar-ficha-btn">Buscar ficha</button>
        </div>
        <div id="ficha-buscar-resultado"></div>
      `;
      document.getElementById('buscar-ficha-btn').onclick = buscarFichaPorRut;
    }
    async function buscarFichaPorRut(){
      let rut = document.getElementById('buscador-rut').value.trim();
      if(!rut){alert("Escribe el RUT a buscar.");return;}
      let snap = await db.collection("solicitudes").where("rut","==",rut).get();
      let div = document.getElementById('ficha-buscar-resultado');
      if(snap.empty){
        div.innerHTML = '<p>No se encontró la ficha.</p>';
      }else{
        snap.forEach(doc=>{
          div.innerHTML = `<button class="btn btn-small" onclick="verFichaUsuario('${doc.id}')">Ver ficha de ${rut}</button>`;
        });
      }
    }

    // Ficha usuario (modal)
    let fichaUsuarioId = null;
    window.verFichaUsuario = function(id){
      fichaUsuarioId = id;
      showModal('modal-bg-ficha');
      mostrarFichaUsuario(id);
    };
    async function mostrarFichaUsuario(id){
      let doc = await db.collection("solicitudes").doc(id).get();
      if(!doc.exists)return;
      let u = doc.data();
      let html = `
        <div class="ficha-label">Nombre:</div> ${u.nombre} ${u.apellido}<br>
        <div class="ficha-label">RUT:</div> ${u.rut}<br>
        <div class="ficha-label">Teléfono:</div> ${u.telefono}<br>
        <div class="ficha-label">Correo:</div> ${u.correo}<br>
        <div class="ficha-label">Comuna:</div> ${u.comuna}<br>
        <div class="ficha-label">Dirección:</div> ${u.direccion}<br>
        <div class="ficha-label">Fecha de solicitud:</div> ${u.fecha}<br>
        <div class="ficha-label">Derivación:</div> ${u.derivacion ? u.derivacion : "sin derivar"}
        ${u.observacion_derivacion?`
          <div class="ficha-label" style="margin-top:10px;">Motivo de derivación:</div>
          <div class="atencion-profesional">${u.observacion_derivacion}<br>
          <small>Por: ${u.nombre_deriva||''} el ${u.fecha_derivacion||''}</small></div>
        `:""}
      `;
      document.getElementById('ficha-usuario-info').innerHTML = html;
      cargarNotasFicha(id);
      document.getElementById('form-nota-ficha').style.display = (
        usuario.profesion==='medico' && u.derivacion==='medico'
      ) ? "block" : (usuario.profesion==='asistente_social' ? "block" : "none");
    }
    document.getElementById('form-nota-ficha').onsubmit = async function(e){
      e.preventDefault();
      const texto = document.getElementById('nota-ficha').value.trim();
      if(!texto)return;
      await db.collection("solicitudes").doc(fichaUsuarioId).collection("notas").add({
        texto,
        fecha: new Date().toLocaleString(),
        profesional: usuario.nombre,
        profesion: usuario.profesion
      });
      document.getElementById('nota-ficha').value = '';
      cargarNotasFicha(fichaUsuarioId);
    };
    async function cargarNotasFicha(id){
      let notasDiv = document.getElementById('ficha-usuario-notas');
      let snap = await db.collection("solicitudes").doc(id).collection("notas").orderBy("fecha").get();
      let html = '<div class="ficha-label" style="margin-bottom:8px;">Atenciones registradas:</div>';
      if(snap.empty){
        html += '<div class="ficha-notas">No hay atenciones registradas aún.</div>';
      }else{
        html += '<div class="ficha-notas">';
        snap.forEach(doc=>{
          let nota = doc.data();
          html += `<div class="ficha-nota-item"><strong>${nota.fecha}:</strong><br>
            ${nota.texto}<br>
            <small>Atendido por: ${nota.profesional} (${nota.profesion==='medico'?'Médico':'Asistente social'})</small>
          </div>`;
        });
        html += '</div>';
      }
      notasDiv.innerHTML = html;
    }
  </script>
</body>
</html>
