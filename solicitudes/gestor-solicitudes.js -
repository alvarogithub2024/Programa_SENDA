// src/js/pacientes/gestor-pacientes.js
import { db } from '../configuracion/firebase.js';
import { obtenerDatosUsuario } from '../autenticacion/sesion.js';
import { mostrarCarga, mostrarNotificacion } from '../utilidades/notificaciones.js';
import { formatearFecha } from '../utilidades/formato.js';
import { mostrarModal } from '../utilidades/modales.js';
import { CONFIG_APP, PRIORIDADES } from '../configuracion/constantes.js';

let datosPacientes = [];

export async function cargarPacientes() {
  const datosUsuario = obtenerDatosUsuario();
  if (!datosUsuario) return;

  try {
    mostrarCarga(true, 'Cargando pacientes...');
    
    const pacientesSnapshot = await db.collection('pacientes')
      .where('cesfam', '==', datosUsuario.cesfam)
      .orderBy('fechaCreacion', 'desc')
      .limit(CONFIG_APP.limitePaginacion)
      .get();
    
    const pacientes = [];
    pacientesSnapshot.forEach(doc => {
      pacientes.push({ id: doc.id, ...doc.data() });
    });
    
    datosPacientes = pacientes;
    renderizarPacientes(pacientes);
    
  } catch (error) {
    console.error('Error cargando pacientes:', error);
    mostrarNotificacion('Error al cargar pacientes: ' + error.message, 'error');
    
    const grilla = document.getElementById('patients-grid');
    if (grilla) {
      grilla.innerHTML = `
        <div class="no-results">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Error al cargar pacientes</h3>
          <p>${error.message}</p>
          <button class="btn btn-primary" onclick="window.SENDA.cargarPacientes()">
            <i class="fas fa-redo"></i>
            Reintentar
          </button>
        </div>
      `;
    }
  } finally {
    mostrarCarga(false);
  }
}

function renderizarPacientes(pacientes) {
  const grilla = document.getElementById('patients-grid');
  if (!grilla) return;

  if (pacientes.length === 0) {
    grilla.innerHTML = `
      <div class="no-results">
        <i class="fas fa-users"></i>
        <h3>No hay pacientes registrados</h3>
        <p>No se encontraron pacientes en este CESFAM</p>
      </div>
    `;
    return;
  }

  grilla.innerHTML = pacientes.map(paciente => crearTarjetaPaciente(paciente)).join('');
}

function crearTarjetaPaciente(paciente) {
  const fecha = formatearFecha(paciente.fechaCreacion);
  const estado = paciente.estado || 'activo';
  
  return `
    <div class="patient-card">
      <div class="patient-header">
        <div class="patient-info">
          <h3>${paciente.nombre} ${paciente.apellidos || ''}</h3>
          <p>RUT: ${paciente.rut}</p>
        </div>
        <span class="patient-status ${estado}">
          ${estado.toUpperCase()}
        </span>
      </div>
      <div class="patient-details">
        <div><strong>Edad:</strong> ${paciente.edad || 'No especificada'} años</div>
        <div><strong>Teléfono:</strong> ${paciente.telefono || 'No disponible'}</div>
        <div><strong>Email:</strong> ${paciente.email || 'No disponible'}</div>
        <div><strong>Registrado:</strong> ${fecha}</div>
      </div>
      <div class="patient-actions">
        <button class="btn btn-sm btn-primary" onclick="window.SENDA.mostrarDetallePaciente('${paciente.id}')">
          <i class="fas fa-eye"></i>
          Ver Ficha
        </button>
      </div>
    </div>
  `;
}

export async function mostrarDetallePaciente(pacienteId) {
  try {
    mostrarCarga(true, 'Cargando ficha del paciente...');
    
    const pacienteDoc = await db.collection('pacientes').doc(pacienteId).get();
    
    if (!pacienteDoc.exists) {
      mostrarNotificacion('Paciente no encontrado', 'error');
      return;
    }
    
    const paciente = { id: pacienteDoc.id, ...pacienteDoc.data() };
    
    const modalDetalle = crearModalDetallePaciente(paciente);
    document.body.insertAdjacentHTML('beforeend', modalDetalle);
    mostrarModal('patient-detail-modal');
    
    await cargarAtencionesPaciente(paciente.rut, `atenciones-list-${paciente.rut}`);
    
  } catch (error) {
    console.error('Error cargando detalle del paciente:', error);
    mostrarNotificacion('Error al cargar ficha del paciente: ' + error.message, 'error');
  } finally {
    mostrarCarga(false);
  }
}

async function cargarAtencionesPaciente(rut, contenedorId) {
  try {
    const datosUsuario = obtenerDatosUsuario();
    const atencionesSnapshot = await db.collection('atenciones')
      .where('pacienteRut', '==', rut)
      .where('cesfam', '==', datosUsuario.cesfam)
      .orderBy('fecha', 'desc')
      .get();

    const contenedor = document.getElementById(contenedorId);
    if (!contenedor) return;

    if (atencionesSnapshot.empty) {
      contenedor.innerHTML = '<p style="color:gray;">Sin atenciones registradas.</p>';
      return;
    }

    const atenciones = [];
    atencionesSnapshot.forEach(doc => atenciones.push(doc.data()));

    contenedor.innerHTML = atenciones.map(atencion => {
      const fecha = atencion.fecha && atencion.fecha.toDate
        ? atencion.fecha.toDate().toLocaleString('es-CL')
        : '';
      return `
        <div class="atencion-item" style="margin-bottom:16px; padding:10px; border:1px solid #dde; border-radius: 8px;">
          <div><strong>Fecha:</strong> ${fecha}</div>
          <div><strong>Profesional:</strong> ${atencion.profesional || ''}</div>
          <div><strong>Detalle:</strong><br> ${atencion.detalle || ''}</div>
        </div>
      `;
    }).join('');
  } catch (err) {
    console.error('Error cargando atenciones:', err);
    const contenedor = document.getElementById(contenedorId);
    if (contenedor) contenedor.innerHTML = '<p style="color:red;">Error al cargar atenciones.</p>';
  }
}

function crearModalDetallePaciente(paciente) {
  const fechaCreacion = formatearFecha(paciente.fechaCreacion);
  const fechaPrimeraAtencion = paciente.fechaPrimeraAtencion ? formatearFecha(paciente.fechaPrimeraAtencion) : 'No registrada';
  const prioridadInfo = PRIORIDADES[paciente.prioridad || 'media'];
  
  return `
    <div class="modal-overlay temp-modal" id="patient-detail-modal">
      <div class="modal large-modal">
        <button class="modal-close" onclick="window.SENDA.cerrarModal('patient-detail-modal')">
          <i class="fas fa-times"></i>
        </button>
        
        <div style="padding: 24px;">
          <h2><i class="fas fa-user-md"></i> Ficha del Paciente</h2>
          
          <div class="patient-info" style="background: var(--light-blue); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
              <div>
                <h3 style="margin: 0; color: var(--primary-blue);">
                  ${paciente.nombre} ${paciente.apellidos || ''}
                </h3>
                <p style="margin: 4px 0; font-weight: 500;">RUT: ${paciente.rut}</p>
              </div>
              <span class="patient-status ${paciente.estado || 'activo'}" style="padding: 6px 12px; border-radius: 6px; font-weight: bold;">
                ${(paciente.estado || 'activo').toUpperCase()}
              </span>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <h4 style="color: var(--primary-blue); margin-bottom: 8px;">Datos Personales</h4>
                <div style="font-size: 14px; line-height: 1.6;">
                  <div><strong>Edad:</strong> ${paciente.edad || 'No especificada'} años</div>
                  <div><strong>Teléfono:</strong> ${paciente.telefono || 'No disponible'}</div>
                  <div><strong>Email:</strong> ${paciente.email || 'No disponible'}</div>
                  <div><strong>Dirección:</strong> ${paciente.direccion || 'No disponible'}</div>
                </div>
              </div>
              
              <div>
                <h4 style="color: var(--primary-blue); margin-bottom: 8px;">Información Clínica</h4>
                <div style="font-size: 14px; line-height: 1.6;">
                  <div><strong>CESFAM:</strong> ${paciente.cesfam}</div>
                  <div><strong>Prioridad:</strong> <span style="color: ${prioridadInfo.color}; font-weight: bold;">${prioridadInfo.label}</span></div>
                  <div><strong>Origen:</strong> ${paciente.origen || 'No especificado'}</div>
                  <div><strong>Motivación inicial:</strong> ${paciente.motivacionInicial || 'No registrada'}/10</div>
                </div>
              </div>
            </div>
            
            ${paciente.sustanciasProblematicas && paciente.sustanciasProblematicas.length > 0 ? 
              `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.5);">
                <h4 style="color: var(--primary-blue); margin-bottom: 8px;">Sustancias Problemáticas</h4>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  ${paciente.sustanciasProblematicas.map(s => `<span class="substance-tag" style="background: var(--primary-blue); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${s}</span>`).join('')}
                </div>
              </div>` : ''
            }
            
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.5); font-size: 12px; color: var(--gray-600);">
              <div><strong>Fecha de registro:</strong> ${fechaCreacion}</div>
              <div><strong>Primera atención:</strong> ${fechaPrimeraAtencion}</div>
              ${paciente.citaInicialId ? `<div><strong>Cita inicial ID:</strong> ${paciente.citaInicialId}</div>` : ''}
            </div>
          </div>
          
          <div id="atenciones-paciente-${paciente.rut}" style="margin-top:24px;">
            <h4 style="margin-bottom:8px;">Historial de Atenciones</h4>
            <div id="atenciones-list-${paciente.rut}">Cargando...</div>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button class="btn btn-outline" onclick="window.SENDA.cerrarModal('patient-detail-modal')">
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Funciones globales para compatibilidad
window.SENDA = {
  ...window.SENDA,
  cargarPacientes,
  mostrarDetallePaciente
};
