// ================= SENDA PUENTE ALTO - JAVASCRIPT CORREGIDO =================
// PARTE 2: JavaScript Principal - TODOS LOS ERRORES CORREGIDOS

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDEjlDOYhHrnavXOKWjdHO0HXILWQhUXv8",
  authDomain: "senda-6d5c9.firebaseapp.com",
  projectId: "senda-6d5c9",
  storageBucket: "senda-6d5c9.firebasestorage.app",
  messagingSenderId: "1090028669785",
  appId: "1:1090028669785:web:d4e1c1b9945fc2fddc1a48",
  measurementId: "G-82DCLW5R2W"
};

// Initialize Firebase
let auth, db;
try {
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  auth = firebase.auth();
  db = firebase.firestore();
  
  db.enablePersistence({
    synchronizeTabs: true
  }).catch((err) => {
    if (err.code === 'failed-precondition') {
      console.warn('Persistencia fall√≥: m√∫ltiples tabs abiertas');
    } else if (err.code === 'unimplemented') {
      console.warn('Persistencia no soportada en este navegador');
    }
  });
  
  console.log('‚úÖ Firebase inicializado correctamente');
} catch (error) {
  console.error('‚ùå Error inicializando Firebase:', error);
}

// Variables globales
let currentUser = null;
let currentUserData = null;
let currentFormStep = 1;
let maxFormStep = 3; // CORREGIDO: Din√°mico seg√∫n tipo de solicitud
let formData = {};
let isDraftSaved = false;
let currentCalendarDate = new Date();
let selectedCalendarDate = null;
let currentFilter = 'todas';
let solicitudesData = [];
let pacientesData = [];
let citasData = [];
let professionalsList = [];
let isLoading = false;

// Configuraci√≥n
const APP_CONFIG = {
  MAX_RETRY_ATTEMPTS: 3,
  RETRY_DELAY: 1000,
  PAGINATION_LIMIT: 50,
  CACHE_DURATION: 5 * 60 * 1000,
  DEBUG_MODE: true
};

const dataCache = new Map();

// ================= FUNCIONES UTILITARIAS =================

function showNotification(message, type = 'info', duration = 4000) {
  try {
    const container = document.getElementById('notifications') || createNotificationsContainer();
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <i class="fas fa-${getNotificationIcon(type)}"></i> 
      <span>${message}</span>
      <button class="notification-close" onclick="this.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
    `;
    
    container.appendChild(notification);
    
    requestAnimationFrame(() => {
      notification.classList.add('show');
    });
    
    setTimeout(() => {
      if (notification.parentElement) {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 300);
      }
    }, duration);
    
  } catch (error) {
    console.error('Error showing notification:', error);
    alert(`${type.toUpperCase()}: ${message}`);
  }
}

function getNotificationIcon(type) {
  const icons = {
    'success': 'check-circle',
    'error': 'exclamation-triangle',
    'warning': 'exclamation-triangle',
    'info': 'info-circle'
  };
  return icons[type] || 'info-circle';
}

function createNotificationsContainer() {
  const container = document.createElement('div');
  container.id = 'notifications';
  container.className = 'notifications-container';
  document.body.appendChild(container);
  return container;
}

function showModal(modalId) {
  try {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      setTimeout(() => {
        const firstInput = modal.querySelector('input:not([type="hidden"]), select, textarea');
        if (firstInput && !firstInput.disabled) {
          firstInput.focus();
        }
      }, 100);
    }
  } catch (error) {
    console.error('Error showing modal:', error);
  }
}

function closeModal(modalId) {
  try {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
      
      if (modal.classList.contains('temp-modal')) {
        modal.remove();
      }
    }
  } catch (error) {
    console.error('Error closing modal:', error);
  }
}

function showLoading(show = true, message = 'Cargando...') {
  try {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      const messageElement = overlay.querySelector('p');
      if (messageElement) {
        messageElement.textContent = message;
      }
      
      if (show) {
        overlay.classList.remove('hidden');
        isLoading = true;
      } else {
        overlay.classList.add('hidden');
        isLoading = false;
      }
    }
  } catch (error) {
    console.error('Error with loading overlay:', error);
  }
}

// ================= FUNCIONES DE VALIDACI√ìN =================

function formatRUT(rut) {
  try {
    if (!rut) return '';
    
    const cleaned = rut.replace(/[^\dKk]/g, '').toUpperCase();
    
    if (cleaned.length < 2) return cleaned;
    
    const body = cleaned.slice(0, -1);
    const dv = cleaned.slice(-1);
    
    const formattedBody = body.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
    
    return `${formattedBody}-${dv}`;
  } catch (error) {
    console.error('Error formatting RUT:', error);
    return rut;
  }
}

function validateRUT(rut) {
  try {
    if (!rut) return false;
    
    const cleaned = rut.replace(/[^\dKk]/g, '').toUpperCase();
    if (cleaned.length < 8 || cleaned.length > 9) return false;
    
    const body = cleaned.slice(0, -1);
    const dv = cleaned.slice(-1);
    
    if (!/^\d+$/.test(body)) return false;
    
    let sum = 0;
    let multiplier = 2;
    
    for (let i = body.length - 1; i >= 0; i--) {
      sum += parseInt(body[i]) * multiplier;
      multiplier = multiplier === 7 ? 2 : multiplier + 1;
    }
    
    const expectedDV = 11 - (sum % 11);
    let finalDV;
    
    if (expectedDV === 11) {
      finalDV = '0';
    } else if (expectedDV === 10) {
      finalDV = 'K';
    } else {
      finalDV = expectedDV.toString();
    }
    
    return dv === finalDV;
  } catch (error) {
    console.error('Error validating RUT:', error);
    return false;
  }
}

function isValidEmail(email) {
  try {
    if (!email) return false;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email.trim());
  } catch (error) {
    console.error('Error validating email:', error);
    return false;
  }
}

function formatPhoneNumber(phone) {
  try {
    if (!phone) return '';
    
    const cleaned = phone.replace(/\D/g, '');
    
    if (cleaned.length === 8 && !cleaned.startsWith('9')) {
      return cleaned.replace(/(\d{4})(\d{4})/, '$1 $2');
    }
    
    if (cleaned.length === 9 && cleaned.startsWith('9')) {
      return '+56 ' + cleaned.replace(/(\d)(\d{4})(\d{4})/, '$1 $2 $3');
    }
    
    if (cleaned.length === 11 && cleaned.startsWith('56')) {
      return '+' + cleaned.replace(/(\d{2})(\d)(\d{4})(\d{4})/, '$1 $2 $3 $4');
    }
    
    return phone;
  } catch (error) {
    console.error('Error formatting phone:', error);
    return phone;
  }
}

function getProfessionName(profession) {
  const names = {
    'asistente_social': 'Asistente Social',
    'medico': 'M√©dico',
    'psicologo': 'Psic√≥logo',
    'terapeuta': 'Terapeuta Ocupacional',
    'coordinador': 'Coordinador Regional',
    'admin': 'Administrador'
  };
  return names[profession] || profession;
}

function formatDate(timestamp) {
  try {
    if (!timestamp) return 'N/A';
    
    let date;
    if (timestamp.toDate && typeof timestamp.toDate === 'function') {
      date = timestamp.toDate();
    } else if (timestamp instanceof Date) {
      date = timestamp;
    } else if (typeof timestamp === 'string' || typeof timestamp === 'number') {
      date = new Date(timestamp);
    } else {
      return 'N/A';
    }
    
    if (isNaN(date.getTime())) return 'N/A';
    
    return date.toLocaleDateString('es-CL', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (error) {
    console.error('Error formatting date:', error);
    return 'N/A';
  }
}

function calculatePriority(evaluationData) {
  try {
    let score = 0;
    
    if (evaluationData.sustancias?.includes('pasta_base')) score += 4;
    if (evaluationData.sustancias?.includes('cocaina')) score += 3;
    if (evaluationData.sustancias?.includes('alcohol')) score += 1;
    if (evaluationData.sustancias?.includes('marihuana')) score += 1;
    
    if (evaluationData.edad < 18) score += 3;
    if (evaluationData.edad >= 65) score += 2;
    
    const tiempoConsumo = evaluationData.tiempoConsumo;
    if (tiempoConsumo === '60+') score += 3;
    if (tiempoConsumo === '24-60') score += 2;
    if (tiempoConsumo === '12-24') score += 1;
    
    if (evaluationData.urgencia === 'critica') score += 5;
    if (evaluationData.urgencia === 'alta') score += 3;
    if (evaluationData.urgencia === 'media') score += 1;
    
    const motivacion = parseInt(evaluationData.motivacion) || 5;
    if (motivacion <= 3) score += 2;
    if (motivacion >= 8) score -= 1;
    
    if (evaluationData.tratamientoPrevio === 'si_senda') score += 2;
    if (evaluationData.tratamientoPrevio === 'si_otro') score += 1;
    
    if (score >= 8) return 'critica';
    if (score >= 5) return 'alta';
    if (score >= 2) return 'media';
    return 'baja';
    
  } catch (error) {
    console.error('Error calculating priority:', error);
    return 'media';
  }
}

async function retryOperation(operation, maxAttempts = APP_CONFIG.MAX_RETRY_ATTEMPTS) {
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      return await operation();
    } catch (error) {
      console.warn(`Intento ${attempt}/${maxAttempts} fall√≥:`, error.message);
      
      if (attempt === maxAttempts) {
        throw error;
      }
      
      await new Promise(resolve => 
        setTimeout(resolve, APP_CONFIG.RETRY_DELAY * Math.pow(2, attempt - 1))
      );
    }
  }
}

function getCachedData(key) {
  const cached = dataCache.get(key);
  if (cached && (Date.now() - cached.timestamp) < APP_CONFIG.CACHE_DURATION) {
    return cached.data;
  }
  return null;
}

function setCachedData(key, data) {
  dataCache.set(key, {
    data,
    timestamp: Date.now()
  });
}

// ================= INICIALIZACI√ìN =================

document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ SENDA Puente Alto iniciando...');
  try {
    initializeApp();
  } catch (error) {
    console.error('‚ùå Error en DOMContentLoaded:', error);
    showNotification('Error al inicializar la aplicaci√≥n: ' + error.message, 'error');
  }
});

function initializeApp() {
  try {
    if (!firebase) {
      throw new Error('Firebase SDK no cargado');
    }
    
    if (!auth || !db) {
      throw new Error('Firebase no est√° inicializado correctamente');
    }

    document.title = "PROGRAMA SENDA PUENTE ALTO";
    const mainTitle = document.getElementById('main-title');
    if (mainTitle) {
      mainTitle.textContent = "PROGRAMA SENDA PUENTE ALTO";
    }

    initializeEventListeners();
    setupFormValidation();
    setupMultiStepForm();
    setupModalControls();
    setupTabFunctionality();
    setupCalendar();
    setupFilters();
    
    auth.onAuthStateChanged(onAuthStateChanged);
    
    console.log('‚úÖ SENDA Platform inicializado correctamente');
    showNotification('Sistema SENDA cargado correctamente', 'success', 2000);
    
  } catch (error) {
    console.error('‚ùå Error inicializando app:', error);
    showNotification('Error al cargar el sistema: ' + error.message, 'error');
  }
}

// ================= GESTI√ìN DE EVENTOS =================

function initializeEventListeners() {
  try {
    const loginProfessionalBtn = document.getElementById('login-professional');
    const logoutBtn = document.getElementById('logout-btn');
    const registerPatientBtn = document.getElementById('register-patient');
    const reentryProgramBtn = document.getElementById('reentry-program');
    const aboutProgramBtn = document.getElementById('about-program');
    
    const searchSolicitudes = document.getElementById('search-solicitudes');
    const searchPacientesRut = document.getElementById('search-pacientes-rut');
    const buscarPacienteBtn = document.getElementById('buscar-paciente-btn');
    
    const priorityFilter = document.getElementById('priority-filter');
    
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const nuevaCitaBtn = document.getElementById('nueva-cita-btn');

    if (loginProfessionalBtn) {
      loginProfessionalBtn.addEventListener('click', () => {
        showModal('login-modal');
      });
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', handleLogout);
    }

    if (registerPatientBtn) {
      registerPatientBtn.addEventListener('click', () => {
        resetForm(); // CORREGIDO: Reset al abrir
        showModal('patient-modal');
      });
    }

    if (reentryProgramBtn) {
      reentryProgramBtn.addEventListener('click', () => {
        showModal('reentry-modal');
      });
    }

    if (aboutProgramBtn) {
      aboutProgramBtn.addEventListener('click', showAboutProgram);
    }

    if (searchSolicitudes) {
      searchSolicitudes.addEventListener('input', debounce(filterSolicitudes, 300));
    }

    if (buscarPacienteBtn) {
      buscarPacienteBtn.addEventListener('click', buscarPacientePorRUT);
    }

    if (searchPacientesRut) {
      searchPacientesRut.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          buscarPacientePorRUT();
        }
      });
      
      searchPacientesRut.addEventListener('input', (e) => {
        e.target.value = formatRUT(e.target.value);
      });
    }

    if (priorityFilter) {
      priorityFilter.addEventListener('change', filterSolicitudes);
    }

    if (prevMonthBtn) {
      prevMonthBtn.addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        renderCalendar();
      });
    }

    if (nextMonthBtn) {
      nextMonthBtn.addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        renderCalendar();
      });
    }

    // CORREGIDO: Nueva cita button
    if (nuevaCitaBtn) {
      nuevaCitaBtn.addEventListener('click', () => {
        if (!currentUserData) {
          showNotification('Debes estar autenticado para crear citas', 'warning');
          return;
        }
        createNuevaCitaModal();
      });
    }

    document.addEventListener('keydown', handleKeyboardShortcuts);
    
    console.log('‚úÖ Event listeners inicializados correctamente');
  } catch (error) {
    console.error('‚ùå Error inicializando event listeners:', error);
  }
}

function handleKeyboardShortcuts(e) {
  try {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      const searchInput = document.getElementById('search-solicitudes');
      if (searchInput && searchInput.style.display !== 'none') {
        searchInput.focus();
      }
    }
    
    if (e.key === 'Escape') {
      const openModal = document.querySelector('.modal-overlay[style*="flex"]');
      if (openModal) {
        closeModal(openModal.id);
      }
    }
  } catch (error) {
    console.error('Error handling keyboard shortcuts:', error);
  }
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ================= AUTENTICACI√ìN =================

function onAuthStateChanged(user) {
  try {
    if (user) {
      currentUser = user;
      loadUserData();
    } else {
      currentUser = null;
      currentUserData = null;
      clearUserCache();
      showPublicContent();
    }
  } catch (error) {
    console.error('‚ùå Error en cambio de estado de autenticaci√≥n:', error);
    showNotification('Error en autenticaci√≥n', 'error');
  }
}

function clearUserCache() {
  try {
    solicitudesData = [];
    pacientesData = [];
    citasData = [];
    professionalsList = [];
    
    dataCache.clear();
    
    const containers = [
      'requests-container',
      'patients-grid',
      'appointments-list',
      'upcoming-appointments-grid',
      'patients-timeline'
    ];
    
    containers.forEach(containerId => {
      const container = document.getElementById(containerId);
      if (container) {
        container.innerHTML = '';
      }
    });
    
  } catch (error) {
    console.error('Error clearing user cache:', error);
  }
}

async function loadUserData() {
  try {
    showLoading(true, 'Cargando datos del usuario...');
    
    if (!currentUser) {
      throw new Error('Usuario no autenticado');
    }

    const cacheKey = `user_${currentUser.uid}`;
    const cachedData = getCachedData(cacheKey);
    
    if (cachedData) {
      currentUserData = cachedData;
      showProfessionalContent();
      await loadInitialData();
      return;
    }

    const userData = await retryOperation(async () => {
      const userDoc = await db.collection('profesionales').doc(currentUser.uid).get();
      
      if (!userDoc.exists) {
        throw new Error('No se encontraron datos del profesional');
      }
      
      return userDoc.data();
    });
    
    currentUserData = userData;
    setCachedData(cacheKey, userData);
    
    showProfessionalContent();
    await loadInitialData();
    
  } catch (error) {
    console.error('‚ùå Error cargando datos del usuario:', error);
    
    if (error.code === 'permission-denied') {
      showNotification('Sin permisos para acceder a los datos', 'error');
    } else if (error.message.includes('No se encontraron datos')) {
      showNotification('Perfil de profesional no encontrado. Contacta al administrador.', 'error');
    } else {
      showNotification('Error al cargar datos del usuario: ' + error.message, 'error');
    }
    
    await handleLogout();
  } finally {
    showLoading(false);
  }
}

async function loadInitialData() {
  try {
    const loadPromises = [];
    
    const activeTab = document.querySelector('.tab-btn.active')?.dataset.tab || 'agenda';
    
    // CORREGIDO: Solo cargar solicitudes si el usuario es asistente social
    if (activeTab === 'solicitudes' && hasAccessToSolicitudes()) {
      loadPromises.push(loadSolicitudes());
    } else if (activeTab === 'pacientes') {
      loadPromises.push(loadPacientes());
    } else if (activeTab === 'agenda') {
      loadPromises.push(loadTodayAppointments());
    } else if (activeTab === 'seguimiento') {
      loadPromises.push(loadSeguimiento());
    }
    
    loadPromises.push(loadProfessionalsList());
    
    await Promise.allSettled(loadPromises);
    
  } catch (error) {
    console.error('‚ùå Error cargando datos iniciales:', error);
  }
}

// CORREGIDO: Funci√≥n para verificar acceso
function hasAccessToSolicitudes() {
  if (!currentUserData) return false;
  return currentUserData.profession === 'asistente_social';
}

function canAccessTab(tabName) {
  if (!currentUserData) return false;
  
  switch (tabName) {
    case 'solicitudes':
      return currentUserData.profession === 'asistente_social';
    case 'agenda':
    case 'seguimiento':
    case 'pacientes':
      return true;
    default:
      return false;
  }
}

async function loadProfessionalsList() {
  try {
    const cacheKey = `professionals_${currentUserData.cesfam}`;
    const cached = getCachedData(cacheKey);
    
    if (cached) {
      professionalsList = cached;
      return;
    }
    
    const snapshot = await db.collection('profesionales')
      .where('cesfam', '==', currentUserData.cesfam)
      .where('activo', '==', true)
      .get();
    
    const professionals = [];
    snapshot.forEach(doc => {
      professionals.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    professionalsList = professionals;
    setCachedData(cacheKey, professionals);
    
  } catch (error) {
    console.error('Error loading professionals list:', error);
  }
}

function showPublicContent() {
  try {
    const publicContent = document.getElementById('public-content');
    const professionalContent = document.getElementById('professional-content');
    const professionalHeader = document.getElementById('professional-header');
    const loginBtn = document.getElementById('login-professional');

    if (publicContent) publicContent.style.display = 'block';
    if (professionalContent) professionalContent.style.display = 'none';
    if (professionalHeader) professionalHeader.style.display = 'none';
    if (loginBtn) loginBtn.style.display = 'flex';
    
    console.log('üìÑ Mostrando contenido p√∫blico');
  } catch (error) {
    console.error('‚ùå Error mostrando contenido p√∫blico:', error);
  }
}

function showProfessionalContent() {
  try {
    const publicContent = document.getElementById('public-content');
    const professionalContent = document.getElementById('professional-content');
    const professionalHeader = document.getElementById('professional-header');
    const loginBtn = document.getElementById('login-professional');

    if (publicContent) publicContent.style.display = 'none';
    if (professionalContent) professionalContent.style.display = 'block';
    if (professionalHeader) professionalHeader.style.display = 'block';
    if (loginBtn) loginBtn.style.display = 'none';
    
    if (currentUserData) {
      updateProfessionalInfo();
      updateTabVisibility();
    }
    
    console.log('üë®‚Äç‚öïÔ∏è Mostrando contenido profesional');
  } catch (error) {
    console.error('‚ùå Error mostrando contenido profesional:', error);
  }
}

function updateTabVisibility() {
  try {
    const tabBtns = document.querySelectorAll('.tab-btn');
    
    tabBtns.forEach(btn => {
      const tabName = btn.dataset.tab;
      if (canAccessTab(tabName)) {
        btn.style.display = 'flex';
      } else {
        btn.style.display = 'none';
        if (btn.classList.contains('active')) {
          btn.classList.remove('active');
          const agendaTab = document.querySelector('.tab-btn[data-tab="agenda"]');
          const agendaPane = document.getElementById('agenda-tab');
          if (agendaTab && agendaPane) {
            agendaTab.classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            agendaPane.classList.add('active');
            loadTabData('agenda');
          }
        }
      }
    });
    
  } catch (error) {
    console.error('Error updating tab visibility:', error);
  }
}

function updateProfessionalInfo() {
  try {
    const professionalName = document.getElementById('professional-name');
    const professionalProfession = document.getElementById('professional-profession');
    const professionalCesfam = document.getElementById('professional-cesfam');

    if (professionalName) {
      professionalName.textContent = `${currentUserData.nombre} ${currentUserData.apellidos}`;
    }
    
    if (professionalProfession) {
      professionalProfession.textContent = getProfessionName(currentUserData.profession);
    }
    
    if (professionalCesfam) {
      professionalCesfam.textContent = currentUserData.cesfam;
    }
    
    const avatar = document.querySelector('.professional-avatar');
    if (avatar) {
      const initials = `${currentUserData.nombre.charAt(0)}${currentUserData.apellidos.charAt(0)}`.toUpperCase();
      avatar.textContent = initials;
    }
    
  } catch (error) {
    console.error('Error updating professional info:', error);
  }
}

// ================= FORMULARIO MULTI-PASO CORREGIDO =================

function setupFormValidation() {
  try {
    const rutInputs = document.querySelectorAll('input[id*="rut"], input[placeholder*="RUT"]');
    rutInputs.forEach(input => {
      input.addEventListener('input', (e) => {
        const formatted = formatRUT(e.target.value);
        e.target.value = formatted;
        
        if (formatted.length > 3) {
          if (validateRUT(formatted)) {
            e.target.classList.remove('error');
            e.target.classList.add('valid');
          } else {
            e.target.classList.add('error');
            e.target.classList.remove('valid');
          }
        }
      });
    });

    const phoneInputs = document.querySelectorAll('input[type="tel"]');
    phoneInputs.forEach(input => {
      input.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^\d\s\+\-]/g, '');
      });
      
      input.addEventListener('blur', (e) => {
        if (e.target.value) {
          e.target.value = formatPhoneNumber(e.target.value);
        }
      });
    });

    const emailInputs = document.querySelectorAll('input[type="email"]');
    emailInputs.forEach(input => {
      input.addEventListener('blur', (e) => {
        const email = e.target.value.trim();
        if (email) {
          if (isValidEmail(email)) {
            e.target.classList.remove('error');
            e.target.classList.add('valid');
          } else {
            e.target.classList.add('error');
            e.target.classList.remove('valid');
          }
        }
      });
    });

    console.log('‚úÖ Validaci√≥n de formularios configurada');
  } catch (error) {
    console.error('‚ùå Error configurando validaci√≥n de formularios:', error);
  }
}

// CORREGIDO: Setup del formulario multi-paso
function setupMultiStepForm() {
  try {
    const form = document.getElementById('patient-form');
    if (!form) return;

    // CORREGIDO: Event listeners para tipo de solicitud
    const tipoSolicitudInputs = document.querySelectorAll('input[name="tipoSolicitud"]');
    tipoSolicitudInputs.forEach(input => {
      input.addEventListener('change', updateFormVisibility);
    });

    // CORREGIDO: Submit info button
    const submitInfoBtn = document.getElementById('submit-info-btn');
    if (submitInfoBtn) {
      submitInfoBtn.addEventListener('click', handleInformationOnlySubmit);
    }

    // Navigation buttons
    const nextBtn1 = document.getElementById('next-step-1');
    const prevBtn2 = document.getElementById('prev-step-2');
    const nextBtn2 = document.getElementById('next-step-2');
    const prevBtn3 = document.getElementById('prev-step-3');

    if (nextBtn1) {
      nextBtn1.addEventListener('click', (e) => {
        e.preventDefault();
        if (validateStep(1)) {
          goToStep(2);
        }
      });
    }

    if (prevBtn2) {
      prevBtn2.addEventListener('click', (e) => {
        e.preventDefault();
        goToStep(1);
      });
    }

    if (nextBtn2) {
      nextBtn2.addEventListener('click', (e) => {
        e.preventDefault();
        if (validateStep(2)) {
          goToStep(3);
        }
      });
    }

    if (prevBtn3) {
      prevBtn3.addEventListener('click', (e) => {
        e.preventDefault();
        goToStep(2);
      });
    }

    form.addEventListener('submit', handlePatientFormSubmit);

    const motivacionRange = document.getElementById('motivacion-range');
    const motivacionValue = document.getElementById('motivacion-value');
    if (motivacionRange && motivacionValue) {
      motivacionRange.addEventListener('input', () => {
        motivacionValue.textContent = motivacionRange.value;
        updateMotivacionColor(motivacionRange.value);
      });
      
      motivacionValue.textContent = motivacionRange.value;
      updateMotivacionColor(motivacionRange.value);
    }

    const reentryForm = document.getElementById('reentry-form');
    if (reentryForm) {
      reentryForm.addEventListener('submit', handleReentrySubmit);
    }

    console.log('‚úÖ Formulario multi-step configurado');
  } catch (error) {
    console.error('‚ùå Error configurando formulario multi-step:', error);
  }
}

// CORREGIDO: Funci√≥n para actualizar visibilidad del formulario
function updateFormVisibility() {
  try {
    const tipoSolicitud = document.querySelector('input[name="tipoSolicitud"]:checked')?.value;
    const infoContainer = document.getElementById('info-email-container');
    const treatmentContainer = document.getElementById('treatment-fields-container');
    const progressContainer = document.getElementById('form-progress-container');
    const progressText = document.getElementById('progress-text');
    
    // Reset visibility
    if (infoContainer) infoContainer.style.display = 'none';
    if (treatmentContainer) treatmentContainer.style.display = 'none';
    
    if (tipoSolicitud === 'informacion') {
      // CORREGIDO: Solo mostrar email para informaci√≥n
      if (infoContainer) infoContainer.style.display = 'block';
      if (progressContainer) progressContainer.style.display = 'none'; // Hide progress
      maxFormStep = 1;
      
      const emailInput = document.getElementById('info-email');
      if (emailInput) {
        emailInput.required = true;
        setTimeout(() => emailInput.focus(), 100);
      }
    } else if (tipoSolicitud === 'identificado') {
      // CORREGIDO: Mostrar campos de tratamiento
      if (treatmentContainer) treatmentContainer.style.display = 'block';
      if (progressContainer) progressContainer.style.display = 'block'; // Show progress
      if (progressText) progressText.textContent = 'Paso 1 de 3';
      maxFormStep = 3;
      
      const emailInput = document.getElementById('info-email');
      if (emailInput) emailInput.required = false;
    }
    
  } catch (error) {
    console.error('Error updating form visibility:', error);
  }
}

function updateMotivacionColor(value) {
  try {
    const motivacionValue = document.getElementById('motivacion-value');
    if (!motivacionValue) return;
    
    const numValue = parseInt(value);
    let color;
    
    if (numValue <= 3) {
      color = 'var(--danger-red)';
    } else if (numValue <= 6) {
      color = 'var(--warning-orange)';
    } else {
      color = 'var(--success-green)';
    }
    
    motivacionValue.style.backgroundColor = color;
    motivacionValue.style.color = 'white';
    motivacionValue.style.padding = '2px 8px';
    motivacionValue.style.borderRadius = '4px';
  } catch (error) {
    console.error('Error updating motivacion color:', error);
  }
}

function validateStep(step) {
  try {
    const tipoSolicitud = document.querySelector('input[name="tipoSolicitud"]:checked')?.value;
    const currentStepDiv = document.querySelector(`.form-step[data-step="${step}"]`);
    if (!currentStepDiv) return false;

    let isValid = true;
    const errors = [];

    if (step === 1) {
      if (!tipoSolicitud) {
        errors.push('Selecciona un tipo de solicitud');
        isValid = false;
      }

      if (tipoSolicitud === 'identificado') {
        const edad = document.getElementById('patient-age')?.value;
        const cesfam = document.getElementById('patient-cesfam')?.value;
        const paraMi = document.querySelector('input[name="paraMi"]:checked')?.value;
        
        if (!edad || !cesfam || !paraMi) {
          errors.push('Completa todos los campos obligatorios');
          isValid = false;
        }

        const edadNum = parseInt(edad);
        if (edad && (edadNum < 12 || edadNum > 120)) {
          errors.push('La edad debe estar entre 12 y 120 a√±os');
          isValid = false;
        }
      }
    }

    if (step === 2) {
      const nombre = document.getElementById('patient-name')?.value?.trim();
      const apellidos = document.getElementById('patient-lastname')?.value?.trim();
      const rut = document.getElementById('patient-rut')?.value?.trim();
      const telefono = document.getElementById('patient-phone')?.value?.trim();
      
      if (!nombre || !apellidos || !rut || !telefono) {
        errors.push('Completa todos los campos obligatorios');
        isValid = false;
      }
      
      if (rut && !validateRUT(rut)) {
        errors.push('RUT inv√°lido');
        isValid = false;
      }

      const email = document.getElementById('patient-email')?.value?.trim();
      if (email && !isValidEmail(email)) {
        errors.push('Email inv√°lido');
        isValid = false;
      }
    }

    if (step === 3) {
      const sustancias = document.querySelectorAll('input[name="sustancias"]:checked');
      if (sustancias.length === 0) {
        errors.push('Selecciona al menos una sustancia');
        isValid = false;
      }

      const urgencia = document.querySelector('input[name="urgencia"]:checked');
      if (!urgencia) {
        errors.push('Selecciona el nivel de urgencia');
        isValid = false;
      }

      const tratamientoPrevio = document.querySelector('input[name="tratamientoPrevio"]:checked');
      if (!tratamientoPrevio) {
        errors.push('Indica si has recibido tratamiento previo');
        isValid = false;
      }

      const tiempoConsumo = document.getElementById('tiempo-consumo')?.value;
      if (!tiempoConsumo) {
        errors.push('Indica hace cu√°nto tiempo consumes');
        isValid = false;
      }
    }

    if (errors.length > 0) {
      showNotification(errors.join('\n'), 'warning', 5000);
    }

    return isValid;
  } catch (error) {
    console.error('Error validating step:', error);
    return false;
  }
}

// CORREGIDO: Funci√≥n para ir a un paso espec√≠fico
function goToStep(step) {
  try {
    if (step < 1 || step > maxFormStep) return;

    document.querySelectorAll('.form-step').forEach(stepDiv => {
      stepDiv.classList.remove('active');
    });
    
    const targetStep = document.querySelector(`.form-step[data-step="${step}"]`);
    if (targetStep) {
      targetStep.classList.add('active');
      
      setTimeout(() => {
        const firstInput = targetStep.querySelector('input:not([type="hidden"]), select, textarea');
        if (firstInput && !firstInput.disabled) {
          firstInput.focus();
        }
      }, 100);
    }

    const progressFill = document.getElementById('form-progress');
    const progressText = document.getElementById('progress-text');
    
    if (progressFill) {
      const progressPercentage = (step / maxFormStep) * 100;
      progressFill.style.width = `${progressPercentage}%`;
    }
    
    if (progressText) {
      progressText.textContent = `Paso ${step} de ${maxFormStep}`;
    }

    currentFormStep = step;
    
  } catch (error) {
    console.error('Error going to step:', error);
  }
}

function resetForm() {
  try {
    const form = document.getElementById('patient-form');
    if (form) {
      form.reset();
      
      // Reset step to 1
      currentFormStep = 1;
      maxFormStep = 3;
      
      // Hide all containers
      const infoContainer = document.getElementById('info-email-container');
      const treatmentContainer = document.getElementById('treatment-fields-container');
      const progressContainer = document.getElementById('form-progress-container');
      
      if (infoContainer) infoContainer.style.display = 'none';
      if (treatmentContainer) treatmentContainer.style.display = 'none';
      if (progressContainer) progressContainer.style.display = 'block';
      
      // Show first step
      document.querySelectorAll('.form-step').forEach(stepDiv => {
        stepDiv.classList.remove('active');
      });
      
      const firstStep = document.querySelector('.form-step[data-step="1"]');
      if (firstStep) {
        firstStep.classList.add('active');
      }
      
      // Reset progress
      const progressFill = document.getElementById('form-progress');
      const progressText = document.getElementById('progress-text');
      
      if (progressFill) progressFill.style.width = '33.33%';
      if (progressText) progressText.textContent = 'Paso 1 de 3';
      
      // Reset motivacion
      const motivacionRange = document.getElementById('motivacion-range');
      const motivacionValue = document.getElementById('motivacion-value');
      if (motivacionRange && motivacionValue) {
        motivacionRange.value = 5;
        motivacionValue.textContent = '5';
        updateMotivacionColor(5);
      }
      
      // Clear errors
      form.querySelectorAll('.error').forEach(field => {
        field.classList.remove('error');
      });
    }
    
    console.log('üîß Formulario reseteado');
  } catch (error) {
    console.error('‚ùå Error reseteando formulario:', error);
  }
}

// ================= EXPORTS GLOBALES =================
window.showModal = showModal;
window.closeModal = closeModal;
window.showNotification = showNotification;
window.formatRUT = formatRUT;
window.validateRUT = validateRUT;
window.goToStep = goToStep;
window.updateFormVisibility = updateFormVisibility;

console.log('‚úÖ SENDA JavaScript Parte 2 CORREGIDO cargado correctamente');
// ================= PARTE 3: MANEJO DE DATOS, SOLICITUDES Y FUNCIONES FINALES =================

// ================= MANEJO DE FORMULARIOS PRINCIPALES =================

// CORREGIDO: Funci√≥n para solicitud de informaci√≥n √∫nicamente
async function handleInformationOnlySubmit() {
  try {
    console.log('üîß Procesando solicitud de informaci√≥n √∫nicamente...');
    
    const email = document.getElementById('info-email')?.value?.trim();
    
    if (!email || !isValidEmail(email)) {
      showNotification('Por favor ingresa un email v√°lido', 'error');
      return;
    }
    
    const submitBtn = document.getElementById('submit-info-btn');
    toggleSubmitButton(submitBtn, true);
    
    const informationData = {
      tipoSolicitud: 'informacion',
      email: email,
      fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
      estado: 'pendiente_respuesta',
      origen: 'web_publica',
      prioridad: 'baja',
      identificador: `INFO_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
    };
    
    console.log('üíæ Guardando solicitud de informaci√≥n...');
    
    await db.collection('solicitudes_informacion').add(informationData);
    
    closeModal('patient-modal');
    resetForm();
    
    showNotification('Solicitud de informaci√≥n enviada correctamente. Te responderemos pronto a tu email.', 'success', 6000);
    
  } catch (error) {
    console.error('‚ùå Error enviando informaci√≥n:', error);
    showNotification('Error al enviar la solicitud: ' + error.message, 'error');
  } finally {
    const submitBtn = document.getElementById('submit-info-btn');
    toggleSubmitButton(submitBtn, false);
  }
}

async function handlePatientFormSubmit(e) {
  e.preventDefault();
  console.log('üìÑ Iniciando env√≠o de solicitud...');
  
  const submitBtn = document.getElementById('submit-form');
  
  try {
    toggleSubmitButton(submitBtn, true);
    
    const tipoSolicitud = document.querySelector('input[name="tipoSolicitud"]:checked')?.value;
    if (!tipoSolicitud) {
      showNotification('Selecciona un tipo de solicitud', 'warning');
      return;
    }

    // Solo para solicitudes identificadas
    if (tipoSolicitud !== 'identificado') {
      showNotification('Tipo de solicitud no v√°lido para este formulario', 'warning');
      return;
    }

    const solicitudData = collectFormDataSafe();
    console.log('üìã Datos recopilados:', solicitudData);
    
    solicitudData.prioridad = calculatePriority(solicitudData);
    console.log('‚ö° Prioridad calculada:', solicitudData.prioridad);
    
    if (!db) {
      throw new Error('No hay conexi√≥n a Firebase');
    }
    
    console.log('üíæ Guardando en Firestore...');
    
    const docRef = await retryOperation(async () => {
      return await db.collection('solicitudes_ingreso').add(solicitudData);
    });
    
    console.log('‚úÖ Solicitud guardada con ID:', docRef.id);
    
    if (solicitudData.prioridad === 'critica') {
      try {
        await createCriticalAlert(solicitudData, docRef.id);
        console.log('üö® Alerta cr√≠tica creada');
      } catch (alertError) {
        console.warn('‚ö†Ô∏è Error creando alerta cr√≠tica:', alertError);
      }
    }
    
    closeModal('patient-modal');
    resetForm();
    
    showNotification('Solicitud enviada correctamente. Te contactaremos pronto para coordinar una cita.', 'success', 6000);
    console.log('üéâ Proceso completado exitosamente');
    
  } catch (error) {
    console.error('‚ùå Error enviando solicitud:', error);
    
    let errorMessage = 'Error al enviar la solicitud: ';
    
    if (error.code === 'permission-denied') {
      errorMessage += 'Sin permisos para crear solicitudes. Verifica las reglas de Firebase.';
    } else if (error.code === 'network-request-failed') {
      errorMessage += 'Problema de conexi√≥n. Verifica tu internet.';
    } else if (error.code === 'unavailable') {
      errorMessage += 'Servicio no disponible temporalmente.';
    } else {
      errorMessage += error.message || 'Intenta nuevamente en unos momentos.';
    }
    
    showNotification(errorMessage, 'error', 8000);
  } finally {
    toggleSubmitButton(submitBtn, false);
  }
}

function collectFormDataSafe() {
  try {
    const tipoSolicitud = document.querySelector('input[name="tipoSolicitud"]:checked')?.value;
    
    if (!tipoSolicitud) {
      throw new Error('Tipo de solicitud no seleccionado');
    }
    
    const solicitudData = {
      tipoSolicitud,
      edad: parseInt(document.getElementById('patient-age')?.value) || null,
      cesfam: document.getElementById('patient-cesfam')?.value || '',
      paraMi: document.querySelector('input[name="paraMi"]:checked')?.value || '',
      fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
      estado: 'pendiente',
      origen: 'web_publica',
      version: '1.0'
    };

    // Datos espec√≠ficos para solicitudes identificadas
    if (tipoSolicitud === 'identificado') {
      const nombre = document.getElementById('patient-name')?.value?.trim();
      const apellidos = document.getElementById('patient-lastname')?.value?.trim();
      const rut = document.getElementById('patient-rut')?.value?.trim();
      const telefono = document.getElementById('patient-phone')?.value?.trim();
      const email = document.getElementById('patient-email')?.value?.trim();
      const direccion = document.getElementById('patient-address')?.value?.trim();

      if (nombre) solicitudData.nombre = nombre;
      if (apellidos) solicitudData.apellidos = apellidos;
      if (rut) solicitudData.rut = formatRUT(rut);
      if (telefono) solicitudData.telefono = formatPhoneNumber(telefono);
      if (email) solicitudData.email = email;
      if (direccion) solicitudData.direccion = direccion;

      // Datos de evaluaci√≥n
      const sustanciasChecked = document.querySelectorAll('input[name="sustancias"]:checked');
      if (sustanciasChecked.length > 0) {
        solicitudData.sustancias = Array.from(sustanciasChecked).map(cb => cb.value);
      }

      const tiempoConsumo = document.getElementById('tiempo-consumo');
      if (tiempoConsumo && tiempoConsumo.value) {
        solicitudData.tiempoConsumo = tiempoConsumo.value;
      }

      const urgencia = document.querySelector('input[name="urgencia"]:checked');
      if (urgencia) {
        solicitudData.urgencia = urgencia.value;
      }

      const tratamientoPrevio = document.querySelector('input[name="tratamientoPrevio"]:checked');
      if (tratamientoPrevio) {
        solicitudData.tratamientoPrevio = tratamientoPrevio.value;
      }

      const descripcion = document.getElementById('patient-description');
      if (descripcion && descripcion.value.trim()) {
        solicitudData.descripcion = descripcion.value.trim();
      }

      const motivacion = document.getElementById('motivacion-range');
      if (motivacion && motivacion.value) {
        solicitudData.motivacion = parseInt(motivacion.value);
      }
    }

    console.log('Datos recopilados exitosamente:', solicitudData);
    return solicitudData;
    
  } catch (error) {
    console.error('Error recopilando datos del formulario:', error);
    throw new Error('Error recopilando datos del formulario: ' + error.message);
  }
}

async function handleReentrySubmit(e) {
  e.preventDefault();
  console.log('üìÑ Iniciando env√≠o de reingreso...');
  
  const formData = {
    nombre: document.getElementById('reentry-name')?.value?.trim() || '',
    rut: document.getElementById('reentry-rut')?.value?.trim() || '',
    cesfam: document.getElementById('reentry-cesfam')?.value || '',
    motivo: document.getElementById('reentry-reason')?.value?.trim() || '',
    telefono: document.getElementById('reentry-phone')?.value?.trim() || ''
  };
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  
  // Validaciones
  const requiredFields = [
    { field: 'nombre', name: 'Nombre' },
    { field: 'rut', name: 'RUT' },
    { field: 'cesfam', name: 'CESFAM' },
    { field: 'motivo', name: 'Motivo' },
    { field: 'telefono', name: 'Tel√©fono' }
  ];

  for (const { field, name } of requiredFields) {
    if (!formData[field]) {
      showNotification(`El campo ${name} es obligatorio`, 'warning');
      return;
    }
  }

  if (!validateRUT(formData.rut)) {
    showNotification('RUT inv√°lido', 'warning');
    return;
  }

  const phoneClean = formData.telefono.replace(/\D/g, '');
  if (phoneClean.length < 8) {
    showNotification('Tel√©fono inv√°lido', 'warning');
    return;
  }

  try {
    toggleSubmitButton(submitBtn, true);
    
    const rutFormatted = formatRUT(formData.rut);
    
    const reingresoData = {
      nombre: formData.nombre,
      rut: rutFormatted,
      telefono: formatPhoneNumber(formData.telefono),
      cesfam: formData.cesfam,
      motivo: formData.motivo,
      fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
      estado: 'pendiente',
      prioridad: 'media',
      tipo: 'reingreso',
      origen: 'web_publica',
      version: '1.0'
    };

    await db.collection('reingresos').add(reingresoData);
    
    closeModal('reentry-modal');
    e.target.reset();
    showNotification('Solicitud de reingreso enviada correctamente. Te contactaremos pronto.', 'success', 5000);
    
  } catch (error) {
    console.error('‚ùå Error enviando reingreso:', error);
    
    let errorMessage = 'Error al enviar la solicitud de reingreso: ';
    if (error.code === 'permission-denied') {
      errorMessage += 'Sin permisos para crear reingresos.';
    } else if (error.code === 'network-request-failed') {
      errorMessage += 'Problema de conexi√≥n. Verifica tu internet.';
    } else {
      errorMessage += error.message || 'Intenta nuevamente.';
    }
    
    showNotification(errorMessage, 'error', 8000);
  } finally {
    toggleSubmitButton(submitBtn, false);
  }
}

async function createCriticalAlert(solicitudData, solicitudId) {
  try {
    const alertData = {
      id_solicitud: solicitudId,
      mensaje: `Nuevo caso cr√≠tico: ${solicitudData.edad} a√±os, urgencia ${solicitudData.urgencia}`,
      prioridad: 'maxima',
      tipo_alerta: 'caso_critico_nuevo',
      estado: 'pendiente',
      fecha_creacion: firebase.firestore.FieldValue.serverTimestamp(),
      notificado: false,
      cesfam: solicitudData.cesfam,
      datos_paciente: {
        edad: solicitudData.edad,
        sustancias: solicitudData.sustancias,
        urgencia: solicitudData.urgencia,
        motivacion: solicitudData.motivacion
      }
    };
    
    await db.collection('alertas_criticas').add(alertData);
    
    console.log('üö® Alerta cr√≠tica creada para solicitud:', solicitudId);
  } catch (error) {
    console.error('‚ùå Error creando alerta cr√≠tica:', error);
  }
}

function toggleSubmitButton(button, loading) {
  try {
    if (!button) return;
    
    const btnText = button.querySelector('.btn-text');
    const btnLoading = button.querySelector('.btn-loading');
    
    if (loading) {
      button.disabled = true;
      button.classList.add('loading');
      if (btnText) btnText.style.display = 'none';
      if (btnLoading) btnLoading.style.display = 'inline-flex';
    } else {
      button.disabled = false;
      button.classList.remove('loading');
      if (btnText) btnText.style.display = 'inline';
      if (btnLoading) btnLoading.style.display = 'none';
    }
  } catch (error) {
    console.error('Error toggling submit button:', error);
  }
}

// ================= GESTI√ìN DE SOLICITUDES CORREGIDA =================

// CORREGIDO: Cargar solicitudes con Firebase conectado
async function loadSolicitudes() {
  if (!currentUserData || !hasAccessToSolicitudes()) {
    console.log('‚ö†Ô∏è Usuario no tiene acceso a solicitudes');
    const container = document.getElementById('requests-container');
    if (container) {
      container.innerHTML = `
        <div class="no-results">
          <i class="fas fa-lock"></i>
          <h3>Sin acceso a solicitudes</h3>
          <p>Solo los asistentes sociales pueden ver las solicitudes</p>
        </div>
      `;
    }
    return;
  }

  try {
    showLoading(true, 'Cargando solicitudes...');
    const container = document.getElementById('requests-container');
    
    if (!container) {
      console.error('‚ùå Container requests-container no encontrado');
      return;
    }
    
    await loadSolicitudesFromFirestore();
    
  } catch (error) {
    console.error('‚ùå Error general cargando solicitudes:', error);
    renderSolicitudesError(error);
  } finally {
    showLoading(false);
  }
}

async function loadSolicitudesFromFirestore() {
  try {
    const container = document.getElementById('requests-container');
    if (container) {
      container.innerHTML = `
        <div class="loading-message">
          <i class="fas fa-spinner fa-spin"></i>
          Cargando solicitudes...
        </div>
      `;
    }
    
    const solicitudes = [];
    const loadPromises = [];
    
    // Cargar solicitudes de ingreso
    loadPromises.push(
      retryOperation(async () => {
        try {
          console.log('üîç Buscando solicitudes para CESFAM:', currentUserData.cesfam);
          
          const snapshot = await db.collection('solicitudes_ingreso')
            .where('cesfam', '==', currentUserData.cesfam)
            .orderBy('fechaCreacion', 'desc')
            .limit(APP_CONFIG.PAGINATION_LIMIT)
            .get();
          
          snapshot.forEach(doc => {
            solicitudes.push({
              id: doc.id,
              tipo: 'solicitud_ingreso',
              ...doc.data()
            });
          });
          
          console.log(`‚úÖ Cargadas ${snapshot.size} solicitudes de ingreso`);
        } catch (error) {
          if (error.code === 'permission-denied') {
            console.warn('‚ö†Ô∏è Sin permisos para solicitudes_ingreso');
          } else {
            throw error;
          }
        }
      })
    );
    
    // Cargar reingresos
    loadPromises.push(
      retryOperation(async () => {
        try {
          const snapshot = await db.collection('reingresos')
            .where('cesfam', '==', currentUserData.cesfam)
            .orderBy('fechaCreacion', 'desc')
            .limit(APP_CONFIG.PAGINATION_LIMIT)
            .get();
          
          snapshot.forEach(doc => {
            solicitudes.push({
              id: doc.id,
              tipo: 'reingreso',
              ...doc.data()
            });
          });
          
          console.log(`‚úÖ Cargados ${snapshot.size} reingresos`);
        } catch (error) {
          if (error.code === 'permission-denied') {
            console.warn('‚ö†Ô∏è Sin permisos para reingresos');
          } else {
            throw error;
          }
        }
      })
    );

    // Cargar solicitudes de informaci√≥n
    loadPromises.push(
      retryOperation(async () => {
        try {
          const snapshot = await db.collection('solicitudes_informacion')
            .orderBy('fechaCreacion', 'desc')
            .limit(20)
            .get();
          
          snapshot.forEach(doc => {
            solicitudes.push({
              id: doc.id,
              tipo: 'solicitud_informacion',
              ...doc.data()
            });
          });
          
          console.log(`‚úÖ Cargadas ${snapshot.size} solicitudes de informaci√≥n`);
        } catch (error) {
          if (error.code === 'permission-denied') {
            console.warn('‚ö†Ô∏è Sin permisos para solicitudes_informacion');
          } else {
            throw error;
          }
        }
      })
    );
    
    await Promise.allSettled(loadPromises);
    
    // Ordenar por fecha
    solicitudes.sort((a, b) => {
      const fechaA = a.fechaCreacion?.toDate() || new Date(0);
      const fechaB = b.fechaCreacion?.toDate() || new Date(0);
      return fechaB - fechaA;
    });
    
    solicitudesData = solicitudes;
    renderSolicitudes(solicitudes);
    
    console.log(`‚úÖ Total solicitudes cargadas: ${solicitudes.length}`);
    
  } catch (error) {
    console.error('‚ùå Error cargando desde Firestore:', error);
    renderSolicitudesError(error);
  }
}

function renderSolicitudes(solicitudes) {
  try {
    const container = document.getElementById('requests-container');
    if (!container) {
      console.error('‚ùå Container requests-container no encontrado');
      return;
    }

    if (solicitudes.length === 0) {
      container.innerHTML = `
        <div class="no-results">
          <i class="fas fa-inbox"></i>
          <h3>No hay solicitudes</h3>
          <p>No se encontraron solicitudes para tu CESFAM</p>
          <button class="btn btn-primary mt-4" onclick="loadSolicitudes()">
            <i class="fas fa-redo"></i>
            Actualizar
          </button>
        </div>
      `;
      return;
    }

    container.innerHTML = solicitudes.map(solicitud => createSolicitudCard(solicitud)).join('');
    
    console.log(`‚úÖ Renderizadas ${solicitudes.length} solicitudes`);
  } catch (error) {
    console.error('‚ùå Error renderizando solicitudes:', error);
  }
}

function createSolicitudCard(solicitud) {
  try {
    const fecha = formatDate(solicitud.fechaCreacion);
    const prioridad = solicitud.prioridad || 'baja';
    const estado = solicitud.estado || 'pendiente';
    
    let titulo, subtitulo, tipoIcon, tipoLabel;
    
    if (solicitud.tipo === 'reingreso') {
      titulo = `Reingreso - ${solicitud.nombre || 'Sin nombre'}`;
      subtitulo = `RUT: ${solicitud.rut || 'No disponible'}`;
      tipoIcon = 'fa-redo';
      tipoLabel = 'REINGRESO';
    } else if (solicitud.tipo === 'solicitud_informacion') {
      titulo = 'Solicitud de Informaci√≥n';
      subtitulo = `Email: ${solicitud.email || 'No disponible'}`;
      tipoIcon = 'fa-info-circle';
      tipoLabel = 'INFORMACI√ìN';
    } else {
      tipoIcon = 'fa-user-plus';
      tipoLabel = 'INGRESO';
      if (solicitud.tipoSolicitud === 'identificado') {
        titulo = `${solicitud.nombre || ''} ${solicitud.apellidos || ''}`.trim() || 'Solicitud identificada';
        subtitulo = `RUT: ${solicitud.rut || 'No disponible'}`;
      } else {
        titulo = 'Solicitud An√≥nima';
        subtitulo = `Edad: ${solicitud.edad || 'No especificada'} a√±os`;
      }
    }

    const sustancias = solicitud.sustancias || [];
    const sustanciasHtml = sustancias.length > 0 ? 
      sustancias.map(s => `<span class="substance-tag">${s}</span>`).join('') : '';

    const prioridadColor = {
      'critica': '#ef4444',
      'alta': '#f59e0b',
      'media': '#3b82f6',
      'baja': '#10b981'
    };

    return `
      <div class="request-card" data-id="${solicitud.id}" onclick="showSolicitudDetail('${solicitud.id}')">
        <div class="request-header">
          <div class="request-info">
            <h3>
              <i class="fas ${tipoIcon}" style="margin-right: 8px; color: var(--primary-blue);"></i>
              ${titulo}
            </h3>
            <p style="color: var(--gray-600);">${subtitulo}</p>
          </div>
          <div class="request-meta">
            <span class="priority-badge ${prioridad}" style="background-color: ${prioridadColor[prioridad]}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
              ${prioridad.toUpperCase()}
            </span>
            <span class="request-type" style="background: #e0e7ff; color: #3730a3; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">${tipoLabel}</span>
          </div>
        </div>
        
        <div class="request-body">
          ${sustanciasHtml ? `<div class="request-substances" style="margin-bottom: 8px;">${sustanciasHtml}</div>` : ''}
          ${solicitud.descripcion || solicitud.motivo ? 
            `<p class="request-description" style="color: var(--gray-700); line-height: 1.5;">${truncateText(solicitud.descripcion || solicitud.motivo, 150)}</p>` : ''}
          
          <div class="request-details" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; font-size: 13px; color: var(--gray-600);">
            <div><strong>Estado:</strong> ${estado.replace('_', ' ').toUpperCase()}</div>
            <div><strong>Fecha:</strong> ${fecha}</div>
            ${solicitud.edad ? `<div><strong>Edad:</strong> ${solicitud.edad} a√±os</div>` : ''}
            ${solicitud.cesfam ? `<div><strong>CESFAM:</strong> ${solicitud.cesfam}</div>` : ''}
          </div>
        </div>
        
        <div class="request-actions" style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
          ${solicitud.tipo !== 'solicitud_informacion' ? 
            `<button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); showAgendaModal('${solicitud.id}')" title="Agendar cita">
              <i class="fas fa-calendar-plus"></i>
              Agendar
            </button>` : 
            `<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); responderInformacion('${solicitud.id}')" title="Responder informaci√≥n">
              <i class="fas fa-reply"></i>
              Responder
            </button>`
          }
          <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); showSolicitudDetail('${solicitud.id}')" title="Ver detalles completos">
            <i class="fas fa-eye"></i>
            Ver Detalle
          </button>
        </div>
      </div>
    `;
  } catch (error) {
    console.error('‚ùå Error creando tarjeta de solicitud:', error);
    return `
      <div class="request-card error-card">
        <div class="request-header">
          <h3>Error al cargar solicitud</h3>
        </div>
        <div class="request-body">
          <p>No se pudo cargar la informaci√≥n de esta solicitud</p>
        </div>
      </div>
    `;
  }
}

function truncateText(text, maxLength) {
  if (!text || text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

function renderSolicitudesError(error) {
  const container = document.getElementById('requests-container');
  if (!container) return;
  
  let errorMessage = 'Error al cargar solicitudes';
  let errorDetails = '';
  
  if (error.code === 'permission-denied') {
    errorMessage = 'Sin permisos de acceso';
    errorDetails = 'No tienes permisos para ver las solicitudes de este CESFAM';
  } else if (error.code === 'unavailable') {
    errorMessage = 'Servicio no disponible';
    errorDetails = 'El servicio est√° temporalmente no disponible';
  } else {
    errorDetails = error.message;
  }
  
  container.innerHTML = `
    <div class="no-results">
      <i class="fas fa-exclamation-triangle" style="color: var(--danger-red);"></i>
      <h3>${errorMessage}</h3>
      <p>${errorDetails}</p>
      <div class="mt-4">
        <button class="btn btn-primary" onclick="loadSolicitudes()">
          <i class="fas fa-redo"></i>
          Reintentar
        </button>
      </div>
    </div>
  `;
}

// ================= AUTENTICACI√ìN CORREGIDA =================

function setupModalControls() {
  try {
    const modalTabs = document.querySelectorAll('.modal-tab');
    modalTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        const modal = tab.closest('.modal');
        
        if (modal) {
          modal.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          modal.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
          const targetForm = modal.querySelector(`#${targetTab}-form`);
          if (targetForm) {
            targetForm.classList.add('active');
            
            setTimeout(() => {
              const firstInput = targetForm.querySelector('input:not([type="hidden"])');
              if (firstInput) firstInput.focus();
            }, 100);
          }
        }
      });
    });

    const closeButtons = document.querySelectorAll('.modal-close, [data-close]');
    closeButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const modalId = btn.dataset.close || btn.closest('.modal-overlay').id;
        closeModal(modalId);
      });
    });

    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');

    if (loginForm) {
      loginForm.addEventListener('submit', handleLogin);
    }

    if (registerForm) {
      registerForm.addEventListener('submit', handleRegister);
    }
    
    console.log('‚úÖ Controles de modal configurados');
  } catch (error) {
    console.error('‚ùå Error configurando controles de modal:', error);
  }
}

async function handleLogin(e) {
  e.preventDefault();
  
  try {
    const email = document.getElementById('login-email')?.value?.trim() || '';
    const password = document.getElementById('login-password')?.value || '';
    const submitBtn = e.target.querySelector('button[type="submit"]');
    
    if (!email || !password) {
      showNotification('Por favor completa todos los campos', 'warning');
      return;
    }

    if (!isValidEmail(email)) {
      showNotification('Email inv√°lido', 'warning');
      return;
    }

    toggleSubmitButton(submitBtn, true);
    
    await retryOperation(async () => {
      await auth.signInWithEmailAndPassword(email, password);
    });
    
    closeModal('login-modal');
    showNotification('Sesi√≥n iniciada correctamente', 'success');
    
    e.target.reset();
    
  } catch (error) {
    console.error('‚ùå Error en login:', error);
    
    let message = 'Error al iniciar sesi√≥n';
    
    switch (error.code) {
      case 'auth/user-not-found':
        message = 'Usuario no encontrado';
        break;
      case 'auth/wrong-password':
        message = 'Contrase√±a incorrecta';
        break;
      case 'auth/invalid-email':
        message = 'Email inv√°lido';
        break;
      case 'auth/user-disabled':
        message = 'Usuario deshabilitado';
        break;
      case 'auth/too-many-requests':
        message = 'Demasiados intentos fallidos. Intenta m√°s tarde';
        break;
      case 'auth/network-request-failed':
        message = 'Error de conexi√≥n. Verifica tu internet';
        break;
      default:
        message = 'Error al iniciar sesi√≥n. Intenta nuevamente';
    }
    
    showNotification(message, 'error');
  } finally {
    const submitBtn = e.target.querySelector('button[type="submit"]');
    if (submitBtn) toggleSubmitButton(submitBtn, false);
  }
}

async function handleRegister(e) {
  e.preventDefault();
  
  try {
    const formData = {
      nombre: document.getElementById('register-name')?.value?.trim() || '',
      apellidos: document.getElementById('register-lastname')?.value?.trim() || '',
      rut: document.getElementById('register-rut')?.value?.trim() || '',
      profession: document.getElementById('register-profession')?.value || '',
      cesfam: document.getElementById('register-cesfam')?.value || '',
      email: document.getElementById('register-email')?.value?.trim() || '',
      password: document.getElementById('register-password')?.value || ''
    };
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    
    // Validaciones
    if (!formData.nombre || !formData.apellidos || !formData.email || !formData.password) {
      showNotification('Por favor completa todos los campos obligatorios', 'warning');
      return;
    }

    if (!validateRUT(formData.rut)) {
      showNotification('RUT inv√°lido', 'warning');
      return;
    }

    if (!isValidEmail(formData.email)) {
      showNotification('Email inv√°lido', 'warning');
      return;
    }

    if (formData.password.length < 6) {
      showNotification('La contrase√±a debe tener al menos 6 caracteres', 'warning');
      return;
    }

    if (!formData.profession || !formData.cesfam) {
      showNotification('Selecciona profesi√≥n y CESFAM', 'warning');
      return;
    }

    toggleSubmitButton(submitBtn, true);
    
    // Crear usuario en Authentication
    const userCredential = await auth.createUserWithEmailAndPassword(formData.email, formData.password);
    const user = userCredential.user;
    
    const professionalData = {
      nombre: formData.nombre,
      apellidos: formData.apellidos,
      rut: formatRUT(formData.rut),
      profession: formData.profession,
      cesfam: formData.cesfam,
      email: formData.email,
      fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
      activo: true,
      configuracion: {
        notificaciones: true,
        idioma: 'es'
      }
    };
    
    // Guardar en Firestore
    await db.collection('profesionales').doc(user.uid).set(professionalData);
    
    closeModal('login-modal');
    showNotification('Cuenta creada exitosamente. ¬°Bienvenido al sistema SENDA!', 'success');
    
    e.target.reset();
    
  } catch (error) {
    console.error('‚ùå Error en registro:', error);
    
    let message = 'Error al crear la cuenta';
    
    switch (error.code) {
      case 'auth/email-already-in-use':
        message = 'Este email ya est√° registrado';
        break;
      case 'auth/invalid-email':
        message = 'Email inv√°lido';
        break;
      case 'auth/weak-password':
        message = 'La contrase√±a es muy d√©bil';
        break;
      case 'auth/network-request-failed':
        message = 'Error de conexi√≥n. Verifica tu internet';
        break;
      case 'permission-denied':
        message = 'Sin permisos para crear profesional. Verifica las reglas de Firebase.';
        break;
      default:
        if (error.message.includes('RUT')) {
          message = error.message;
        }
    }
    
    showNotification(message, 'error');
    
    // Si se cre√≥ el usuario pero fall√≥ Firestore, eliminarlo
    if (error.code === 'permission-denied' && auth.currentUser) {
      try {
        await auth.currentUser.delete();
        console.log('Usuario de autenticaci√≥n eliminado debido a error en Firestore');
      } catch (deleteError) {
        console.error('Error eliminando usuario:', deleteError);
      }
    }
  } finally {
    const submitBtn = e.target.querySelector('button[type="submit"]');
    if (submitBtn) toggleSubmitButton(submitBtn, false);
  }
}

async function handleLogout() {
  try {
    const confirmed = confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?');
    if (!confirmed) return;
    
    showLoading(true, 'Cerrando sesi√≥n...');
    
    await auth.signOut();
    showNotification('Sesi√≥n cerrada correctamente', 'info');
    
  } catch (error) {
    console.error('‚ùå Error al cerrar sesi√≥n:', error);
    showNotification('Error al cerrar sesi√≥n', 'error');
  } finally {
    showLoading(false);
  }
}

// ================= FUNCIONES ADICIONALES =================

// CORREGIDO: Modal de nueva cita funcional
function createNuevaCitaModal() {
  try {
    console.log('üîß Creando modal de nueva cita...');
    
    const nuevaCitaModal = `
      <div class="modal-overlay temp-modal" id="nueva-cita-modal">
        <div class="modal large-modal">
          <button class="modal-close" onclick="closeModal('nueva-cita-modal')">
            <i class="fas fa-times"></i>
          </button>
          
          <div style="padding: 24px;">
            <h2><i class="fas fa-calendar-plus"></i> Nueva Cita</h2>
            
            <form id="nueva-cita-form">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                <div class="form-group">
                  <label class="form-label">Nombre del Paciente *</label>
                  <input type="text" class="form-input" id="nueva-cita-nombre" required>
                </div>
                
                <div class="form-group">
                  <label class="form-label">RUT *</label>
                  <input type="text" class="form-input" id="nueva-cita-rut" placeholder="12.345.678-9" required>
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                <div class="form-group">
                  <label class="form-label">Profesional *</label>
                  <select class="form-select" id="nueva-cita-professional" required>
                    <option value="">Seleccionar profesional...</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Fecha *</label>
                  <input type="date" class="form-input" id="nueva-cita-date" required>
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">Hora *</label>
                <select class="form-select" id="nueva-cita-time" required>
                  <option value="">Seleccionar hora...</option>
                  <option value="08:00">08:00</option>
                  <option value="08:30">08:30</option>
                  <option value="09:00">09:00</option>
                  <option value="09:30">09:30</option>
                  <option value="10:00">10:00</option>
                  <option value="10:30">10:30</option>
                  <option value="11:00">11:00</option>
                  <option value="11:30">11:30</option>
                  <option value="12:00">12:00</option>
                  <option value="14:00">14:00</option>
                  <option value="14:30">14:30</option>
                  <option value="15:00">15:00</option>
                  <option value="15:30">15:30</option>
                  <option value="16:00">16:00</option>
                </select>
              </div>
              
              <div class="form-group" style="margin-top: 24px;">
                <label class="form-label">Observaciones</label>
                <textarea class="form-textarea" id="nueva-cita-notes" rows="3" 
                          placeholder="Observaciones adicionales para la cita..."></textarea>
              </div>
              
              <div class="form-actions" style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" class="btn btn-outline" onclick="closeModal('nueva-cita-modal')">
                  <i class="fas fa-times"></i>
                  Cancelar
                </button>
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-calendar-check"></i>
                  Crear Cita
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', nuevaCitaModal);
    showModal('nueva-cita-modal');
    
    // Configurar fecha m√≠nima (hoy)
    const dateInput = document.getElementById('nueva-cita-date');
    if (dateInput) {
      const today = new Date().toISOString().split('T')[0];
      dateInput.min = today;
    }

    // Formateo de RUT
    const rutInput = document.getElementById('nueva-cita-rut');
    if (rutInput) {
      rutInput.addEventListener('input', (e) => {
        e.target.value = formatRUT(e.target.value);
      });
    }

    // Cargar profesionales
    loadProfessionalsForCita();
    
    // Event listener para el formulario
    const form = document.getElementById('nueva-cita-form');
    if (form) {
      form.addEventListener('submit', handleNuevaCitaSubmit);
    }
    
    console.log('‚úÖ Modal de nueva cita creado correctamente');
    
  } catch (error) {
    console.error('Error creating nueva cita modal:', error);
    showNotification('Error al abrir modal de nueva cita', 'error');
  }
}

async function loadProfessionalsForCita() {
  try {
    const professionalSelect = document.getElementById('nueva-cita-professional');
    if (!professionalSelect || !currentUserData) return;

    const professionals = await loadProfessionalsByArea();
    
    professionalSelect.innerHTML = '<option value="">Seleccionar profesional...</option>';
    
    professionals.forEach(prof => {
      const option = document.createElement('option');
      option.value = prof.id;
      option.textContent = `${prof.nombre} ${prof.apellidos} - ${getProfessionName(prof.profession)}`;
      option.dataset.profession = prof.profession;
      option.dataset.nombre = `${prof.nombre} ${prof.apellidos}`;
      professionalSelect.appendChild(option);
    });
    
  } catch (error) {
    console.error('Error loading professionals for cita:', error);
  }
}

async function loadProfessionalsByArea() {
  try {
    if (!currentUserData) return [];
    
    const snapshot = await db.collection('profesionales')
      .where('cesfam', '==', currentUserData.cesfam)
      .where('activo', '==', true)
      .get();
    
    const professionals = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      professionals.push({
        id: doc.id,
        nombre: data.nombre,
        apellidos: data.apellidos,
        profession: data.profession,
        cesfam: data.cesfam,
        email: data.email
      });
    });
    
    return professionals;
  } catch (error) {
    console.error('Error loading professionals:', error);
    return [];
  }
}

async function handleNuevaCitaSubmit(e) {
  e.preventDefault();
  
  try {
    const formData = {
      nombre: document.getElementById('nueva-cita-nombre')?.value?.trim(),
      rut: document.getElementById('nueva-cita-rut')?.value?.trim(),
      professionalId: document.getElementById('nueva-cita-professional')?.value,
      fecha: document.getElementById('nueva-cita-date')?.value,
      hora: document.getElementById('nueva-cita-time')?.value,
      observaciones: document.getElementById('nueva-cita-notes')?.value?.trim() || ''
    };
    
    // Validaciones
    if (!formData.nombre || !formData.rut || !formData.professionalId || !formData.fecha || !formData.hora) {
      showNotification('Completa todos los campos obligatorios', 'warning');
      return;
    }
    
    if (!validateRUT(formData.rut)) {
      showNotification('RUT inv√°lido', 'warning');
      return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    toggleSubmitButton(submitBtn, true);
    
    // Obtener datos del profesional
    const professionalSelect = document.getElementById('nueva-cita-professional');
    const selectedOption = professionalSelect.options[professionalSelect.selectedIndex];
    const profesionalNombre = selectedOption.dataset.nombre;
    const tipoProfesional = selectedOption.dataset.profession;
    
    // Crear fecha y hora completa
    const fechaCompleta = new Date(`${formData.fecha}T${formData.hora}:00`);
    
    const citaData = {
      profesionalId: formData.professionalId,
      profesionalNombre: profesionalNombre,
      tipoProfesional: tipoProfesional,
      pacienteNombre: formData.nombre,
      pacienteRut: formatRUT(formData.rut),
      fecha: fechaCompleta,
      estado: 'programada',
      tipo: 'cita_directa',
      cesfam: currentUserData.cesfam,
      observaciones: formData.observaciones,
      fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
      creadoPor: currentUser.uid
    };
    
    // Guardar cita
    await db.collection('citas').add(citaData);
    
    closeModal('nueva-cita-modal');
    
    showNotification(`Cita creada exitosamente para ${fechaCompleta.toLocaleDateString('es-CL')} a las ${formData.hora}`, 'success', 5000);
    
    // Recargar datos si estamos en la tab de agenda
    const activeTab = document.querySelector('.tab-btn.active')?.dataset.tab;
    if (activeTab === 'agenda') {
      loadTodayAppointments();
    }
    
  } catch (error) {
    console.error('Error creando nueva cita:', error);
    showNotification('Error al crear cita: ' + error.message, 'error');
  } finally {
    const submitBtn = e.target.querySelector('button[type="submit"]');
    if (submitBtn) toggleSubmitButton(submitBtn, false);
  }
}

// Funci√≥n para mostrar informaci√≥n del programa
function showAboutProgram() {
  const aboutModal = `
    <div class="modal-overlay temp-modal" id="about-modal">
      <div class="modal">
        <button class="modal-close" onclick="closeModal('about-modal')">
          <i class="fas fa-times"></i>
        </button>
        <h2>Sobre el Programa SENDA</h2>
        <div style="padding: 20px; line-height: 1.6;">
          <p><strong>SENDA (Servicio Nacional para la Prevenci√≥n y Rehabilitaci√≥n del Consumo de Drogas y Alcohol)</strong></p>
          <p>Es el organismo del gobierno de Chile encargado de elaborar las pol√≠ticas de prevenci√≥n del consumo de drogas y alcohol, as√≠ como de tratamiento, rehabilitaci√≥n e integraci√≥n social de las personas afectadas por estas sustancias.</p>
          
          <h4>Nuestros Servicios:</h4>
          <ul>
            <li>Atenci√≥n ambulatoria b√°sica e intensiva</li>
            <li>Tratamiento residencial</li>
            <li>Programas de reinserci√≥n social</li>
            <li>Apoyo familiar</li>
            <li>Prevenci√≥n comunitaria</li>
          </ul>
          
          <h4>Contacto Nacional:</h4>
          <p>üìû Fono Drogas: 1412 (gratuito, 24 horas)</p>
          <p>üåê <a href="https://www.senda.gob.cl" target="_blank">www.senda.gob.cl</a></p>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', aboutModal);
  showModal('about-modal');
}

// ================= FUNCIONES PLACEHOLDER PARA IMPLEMENTAR =================

function setupTabFunctionality() {
  console.log('‚úÖ Tab functionality setup');
  
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabPanes = document.querySelectorAll('.tab-pane');
  
  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetTab = btn.dataset.tab;
      
      // Verificar acceso
      if (!canAccessTab(targetTab)) {
        showNotification('No tienes acceso a esta secci√≥n', 'warning');
        return;
      }
      
      // Remover clase active
      tabBtns.forEach(b => b.classList.remove('active'));
      tabPanes.forEach(p => p.classList.remove('active'));
      
      // Agregar clase active
      btn.classList.add('active');
      const targetPane = document.getElementById(`${targetTab}-tab`);
      if (targetPane) {
        targetPane.classList.add('active');
        loadTabData(targetTab);
      }
    });
  });
}

function setupCalendar() {
  console.log('‚úÖ Calendar setup');
  currentCalendarDate = new Date();
}

function setupFilters() {
  console.log('‚úÖ Filters setup');
  
  const filterBtns = document.querySelectorAll('.filter-btn');
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      filterSolicitudes();
    });
  });
}

function loadTabData(tabName) {
  console.log(`üîÑ Cargando datos para tab: ${tabName}`);
  
  switch (tabName) {
    case 'solicitudes':
      if (hasAccessToSolicitudes()) {
        loadSolicitudes();
      }
      break;
    case 'pacientes':
      loadPacientes();
      break;
    case 'agenda':
      loadTodayAppointments();
      break;
    case 'seguimiento':
      loadSeguimiento();
      break;
  }
}

function filterSolicitudes() {
  console.log('üîç Filtrando solicitudes...');
  
  const searchTerm = document.getElementById('search-solicitudes')?.value?.toLowerCase() || '';
  const priorityFilter = document.getElementById('priority-filter')?.value || '';
  
  let filtered = solicitudesData;
  
  // Filtrar por t√©rmino de b√∫squeda
  if (searchTerm) {
    filtered = filtered.filter(solicitud => {
      const nombre = `${solicitud.nombre || ''} ${solicitud.apellidos || ''}`.toLowerCase();
      const rut = (solicitud.rut || '').toLowerCase();
      const email = (solicitud.email || '').toLowerCase();
      
      return nombre.includes(searchTerm) || 
             rut.includes(searchTerm) || 
             email.includes(searchTerm);
    });
  }
  
  // Filtrar por prioridad
  if (priorityFilter) {
    filtered = filtered.filter(solicitud => solicitud.prioridad === priorityFilter);
  }
  
  // Filtrar por estado
  if (currentFilter !== 'todas') {
    filtered = filtered.filter(solicitud => solicitud.estado === currentFilter);
  }
  
  renderSolicitudes(filtered);
}

function loadPacientes() {
  console.log('üìã Cargando pacientes - placeholder');
}

function loadTodayAppointments() {
  console.log('üìÖ Cargando citas de hoy - placeholder');
}

function loadSeguimiento() {
  console.log('üë• Cargando seguimiento - placeholder');
}

function renderCalendar() {
  console.log('üìÖ Renderizando calendario - placeholder');
}

function buscarPacientePorRUT() {
  console.log('üîç Buscar paciente por RUT - placeholder');
}

function showSolicitudDetail(solicitudId) {
  console.log('üëÅÔ∏è Mostrar detalle de solicitud:', solicitudId);
  showNotification('Funcionalidad en desarrollo', 'info');
}

function showAgendaModal(solicitudId) {
  console.log('üìÖ Mostrar modal de agenda para solicitud:', solicitudId);
  showNotification('Funcionalidad en desarrollo', 'info');
}

function responderInformacion(solicitudId) {
  console.log('üìß Responder informaci√≥n para solicitud:', solicitudId);
  showNotification('Funcionalidad en desarrollo', 'info');
}

// ================= EXPORTS GLOBALES FINALES =================
window.showModal = showModal;
window.closeModal = closeModal;
window.showNotification = showNotification;
window.formatRUT = formatRUT;
window.validateRUT = validateRUT;
window.showAboutProgram = showAboutProgram;
window.handlePatientFormSubmit = handlePatientFormSubmit;
window.handleReentrySubmit = handleReentrySubmit;
window.handleLogin = handleLogin;
window.handleRegister = handleRegister;
window.goToStep = goToStep;
window.updateFormVisibility = updateFormVisibility;
window.handleInformationOnlySubmit = handleInformationOnlySubmit;
window.createNuevaCitaModal = createNuevaCitaModal;
window.loadSolicitudes = loadSolicitudes;
window.filterSolicitudes = filterSolicitudes;
window.showSolicitudDetail = showSolicitudDetail;
window.showAgendaModal = showAgendaModal;
window.responderInformacion = responderInformacion;

console.log('‚úÖ SENDA JavaScript COMPLETO Y CORREGIDO cargado correctamente');
